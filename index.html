<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planner</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');

        * { margin:0; padding:0; box-sizing:border-box; }

        :root {
            --meeting:#667eea; --task:#48bb78; --admin:#f6ad55; --pto:#666;
            --bg:#000; --card:#0a0a0a; --card-hover:#111;
            --border:#222; --text:#fff; --muted:#888; --danger:#ff4444;
        }

        body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* ‚îÄ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ‚îÄ */
        .overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.85);
            z-index:100; display:flex; align-items:center; justify-content:center;
            backdrop-filter:blur(4px);
        }
        .panel {
            background:#111; border:1px solid var(--border); border-radius:16px;
            width:520px; max-width:92vw; overflow:hidden;
        }
        .progress-bar { height:3px; background:var(--border); }
        .progress-fill { height:100%; background:var(--task); transition:width .4s cubic-bezier(.4,0,.2,1); }
        .panel-body { padding:48px 40px 40px; }

        .step { display:none; animation:fadeUp .3s ease; }
        .step.active { display:block; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        .step-emoji { font-size:36px; margin-bottom:18px; display:block; }
        .step h2 { font-size:22px; font-weight:700; margin-bottom:8px; letter-spacing:-.3px; }
        .step > p { color:var(--muted); font-size:14px; line-height:1.6; margin-bottom:28px; }

        /* input rows */
        .irow {
            display:flex; align-items:center; gap:14px;
            background:var(--card); border:1px solid var(--border);
            border-radius:10px; padding:16px 18px; margin-bottom:10px;
            transition:border-color .2s;
        }
        .irow:focus-within { border-color:#444; }
        .irow .icon { font-size:20px; flex-shrink:0; width:28px; text-align:center; }
        .irow .lbl { flex:1; font-size:14px; font-weight:500; }
        .irow .lbl small { display:block; font-size:12px; color:var(--muted); font-weight:400; margin-top:2px; }
        .irow input, .irow select {
            width:88px; padding:9px 10px; background:#1a1a1a;
            border:1px solid var(--border); border-radius:6px;
            color:#fff; font-family:'DM Mono',monospace;
            font-size:15px; font-weight:500; text-align:center;
        }
        .irow input:focus, .irow select:focus { outline:none; border-color:#555; }
        .irow .unit { font-size:13px; color:var(--muted); white-space:nowrap; }

        /* days toggle */
        .days-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:7px; }
        .day-tog {
            background:var(--card); border:1px solid var(--border);
            border-radius:8px; padding:13px 0; text-align:center; cursor:pointer; transition:all .2s;
        }
        .day-tog .dlbl { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
        .day-tog.on { border-color:var(--task); background:rgba(72,187,120,.08); }
        .day-tog.on .dlbl { color:var(--task); }

        /* calc box */
        .calc-box {
            background:rgba(72,187,120,.08); border:1px solid rgba(72,187,120,.25);
            border-radius:10px; padding:16px 18px; margin-top:18px;
            display:flex; align-items:center; gap:14px;
        }
        .calc-box .big { font-family:'DM Mono',monospace; font-size:26px; font-weight:700; color:var(--task); }
        .calc-box .desc { font-size:13px; color:var(--muted); }
        .calc-box .desc strong { color:var(--text); display:block; font-size:14px; margin-bottom:1px; }

        /* nav */
        .nav-row { display:flex; justify-content:space-between; align-items:center; margin-top:32px; }
        .nav-row .indicator { font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.8px; }
        .nav-btns { display:flex; gap:10px; }

        .btn-ghost {
            background:none; border:1px solid var(--border); color:var(--muted);
            padding:10px 22px; border-radius:6px; font-size:13px; font-weight:600;
            cursor:pointer; font-family:inherit; transition:all .2s;
        }
        .btn-ghost:hover { border-color:#444; color:var(--text); }

        .btn-solid {
            background:var(--text); color:#000; border:none;
            padding:10px 28px; border-radius:6px; font-size:13px; font-weight:700;
            cursor:pointer; font-family:inherit; text-transform:uppercase;
            letter-spacing:.8px; transition:all .2s;
        }
        .btn-solid:hover { background:#e5e5e5; transform:translateY(-1px); }

        /* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
        .settings-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:26px 32px 18px; border-bottom:1px solid var(--border);
        }
        .settings-header h2 { font-size:20px; font-weight:700; }
        .close-btn {
            background:none; border:none; color:var(--muted); font-size:22px;
            cursor:pointer; padding:4px 8px; border-radius:6px; transition:all .2s;
        }
        .close-btn:hover { color:var(--text); background:var(--border); }
        .settings-body { padding:24px 32px 32px; }
        .settings-label {
            font-size:11px; font-weight:700; color:var(--muted);
            text-transform:uppercase; letter-spacing:.8px;
            margin-bottom:10px; margin-top:22px;
        }
        .settings-label:first-child { margin-top:0; }

        /* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
        .app { display:none; }
        .app.on { display:block; }

        .header {
            background:var(--bg); padding:28px 36px;
            border-bottom:1px solid var(--border);
            display:flex; justify-content:space-between; align-items:center;
        }
        .header h1 { font-size:30px; font-weight:700; letter-spacing:-.8px; }
        .hdr-btns { display:flex; gap:10px; }
        .btn-hdr {
            background:var(--card); border:1px solid var(--border); color:var(--muted);
            padding:9px 16px; border-radius:6px; font-size:13px; font-weight:600;
            cursor:pointer; font-family:inherit; display:flex; align-items:center; gap:7px;
            transition:all .2s;
        }
        .btn-hdr:hover { border-color:#444; color:var(--text); }
        .btn-hdr.danger:hover { border-color:var(--danger); color:var(--danger); }

        .layout { display:grid; grid-template-columns:380px 1fr; min-height:calc(100vh - 74px); }

        /* sidebar */
        .sidebar { border-right:1px solid var(--border); padding:32px 28px; overflow-y:auto; }

        .sec-title {
            font-size:12px; font-weight:700; color:var(--muted);
            text-transform:uppercase; letter-spacing:1px;
            margin-bottom:14px; display:flex; align-items:center; gap:9px;
        }
        .sec-title svg { opacity:.7; }

        .ig { margin-bottom:12px; }
        .ig label { display:block; font-size:11px; font-weight:600; color:var(--muted); margin-bottom:5px; text-transform:uppercase; letter-spacing:.5px; }
        .ig input, .ig select {
            width:100%; padding:11px 13px; border:1px solid var(--border);
            border-radius:6px; font-size:14px; font-family:inherit;
            background:var(--card); color:var(--text); transition:border-color .2s;
        }
        .ig input:focus, .ig select:focus { outline:none; border-color:#444; }

        .row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

        .add-btn {
            width:100%; padding:12px; border:none; border-radius:6px;
            font-size:12px; font-weight:700; cursor:pointer; font-family:inherit;
            text-transform:uppercase; letter-spacing:.8px;
            background:var(--text); color:#000; transition:all .2s;
        }
        .add-btn:hover { background:#e5e5e5; transform:translateY(-1px); }

        .divider { height:1px; background:var(--border); margin:24px 0; }

        /* full day toggle */
        .fullday-row {
            display:flex; align-items:center; gap:12px;
            padding:10px 13px; background:var(--card);
            border:1px solid var(--border); border-radius:6px;
            margin-bottom:12px; cursor:pointer; transition:border-color .2s;
        }
        .fullday-row:hover { border-color:#444; }
        .fullday-row.active { border-color:var(--pto); background:rgba(102,102,102,.12); }

        .toggle-track {
            width:36px; height:20px; background:#333;
            border-radius:10px; position:relative; transition:background .2s;
            flex-shrink:0;
        }
        .toggle-track.on { background:var(--pto); }
        .toggle-track .knob {
            width:16px; height:16px; background:#fff; border-radius:50%;
            position:absolute; top:2px; left:2px; transition:left .2s;
        }
        .toggle-track.on .knob { left:18px; }

        .fullday-label { font-size:13px; font-weight:500; }
        .fullday-label small { display:block; font-size:11px; color:var(--muted); font-weight:400; }

        /* ‚îÄ‚îÄ‚îÄ RECURRING chips in sidebar ‚îÄ‚îÄ‚îÄ */
        .rec-chip {
            display:flex; align-items:center; gap:10px;
            background:var(--card); border:1px solid var(--border);
            border-left:3px solid var(--meeting); border-radius:6px;
            padding:10px 12px; margin-bottom:8px;
        }
        .rec-chip .rc-inner { flex:1; min-width:0; }
        .rec-chip .rc-name { font-size:14px; font-weight:600; }
        .rec-chip .rc-meta { font-size:11px; color:var(--muted); margin-top:2px; }
        .rec-chip .rc-del {
            background:none; border:none; color:var(--muted); cursor:pointer;
            font-size:16px; line-height:1; padding:2px; transition:color .2s;
        }
        .rec-chip .rc-del:hover { color:var(--danger); }

        /* biweekly parity toggle row */
        .parity-row {
            display:flex; align-items:center; gap:10px;
            background:rgba(102,187,255,.06); border:1px solid rgba(102,187,255,.2);
            border-radius:6px; padding:10px 12px; margin-bottom:12px;
        }
        .parity-row span { font-size:12px; color:#7cc; flex:1; }
        .parity-btn {
            background:none; border:1px solid rgba(102,187,255,.3); color:#7cc;
            padding:5px 10px; border-radius:4px; font-size:11px; font-weight:700;
            cursor:pointer; font-family:inherit; transition:all .2s;
        }
        .parity-btn:hover { border-color:#7cc; color:#fff; }

        /* ‚îÄ‚îÄ‚îÄ SUGGESTIONS TRAY ‚îÄ‚îÄ‚îÄ */
        .suggestions-tray {
            background:rgba(102,126,234,.06); border:1px solid rgba(102,126,234,.25);
            border-radius:10px; padding:18px 20px; margin-bottom:24px;
        }
        .suggestions-title {
            font-size:11px; font-weight:700; color:var(--meeting);
            text-transform:uppercase; letter-spacing:.8px; margin-bottom:12px;
            display:flex; align-items:center; gap:8px;
        }
        .suggestions-title .s-count {
            background:var(--meeting); color:#fff; font-size:10px;
            padding:2px 7px; border-radius:10px; font-weight:700;
        }
        .suggestion-item {
            display:flex; align-items:center; gap:12px;
            background:rgba(0,0,0,.3); border:1px solid rgba(102,126,234,.15);
            border-radius:6px; padding:11px 13px; margin-bottom:8px;
        }
        .suggestion-item:last-child { margin-bottom:0; }
        .suggestion-item .si-inner { flex:1; min-width:0; }
        .suggestion-item .si-name { font-size:14px; font-weight:600; }
        .suggestion-item .si-meta { font-size:11px; color:var(--muted); margin-top:2px; }
        .si-btns { display:flex; gap:6px; flex-shrink:0; }
        .si-btn {
            padding:6px 12px; border-radius:4px; font-size:11px; font-weight:700;
            cursor:pointer; font-family:inherit; border:none; transition:all .15s;
            text-transform:uppercase; letter-spacing:.5px;
        }
        .si-btn.add { background:var(--meeting); color:#fff; }
        .si-btn.add:hover { background:#7b8ef5; transform:translateY(-1px); }
        .si-btn.skip { background:transparent; color:var(--muted); border:1px solid var(--border); }
        .si-btn.skip:hover { border-color:#555; color:var(--text); }

        /* ‚îÄ‚îÄ‚îÄ wizard recurring mini-form ‚îÄ‚îÄ‚îÄ */
        .wiz-rec-form {
            background:var(--card); border:1px solid var(--border);
            border-radius:8px; padding:16px; margin-bottom:14px;
        }
        .wiz-rec-form .wr-row { display:flex; gap:8px; margin-bottom:10px; }
        .wiz-rec-form .wr-row:last-child { margin-bottom:0; }
        .wiz-rec-form input, .wiz-rec-form select {
            padding:9px 10px; background:#1a1a1a; border:1px solid var(--border);
            border-radius:6px; color:#fff; font-family:inherit; font-size:13px;
            transition:border-color .2s;
        }
        .wiz-rec-form input:focus, .wiz-rec-form select:focus { outline:none; border-color:#555; }
        .wiz-rec-form .wr-name { flex:1; min-width:0; }
        .wiz-rec-form .wr-dur { width:68px; text-align:center; font-family:'DM Mono',monospace; }
        .wiz-rec-form .wr-add {
            background:var(--meeting); color:#fff; border:none;
            padding:9px 14px; border-radius:6px; font-size:11px; font-weight:700;
            cursor:pointer; font-family:inherit; text-transform:uppercase;
            letter-spacing:.5px; transition:all .15s; white-space:nowrap;
        }
        .wiz-rec-form .wr-add:hover { background:#7b8ef5; }

        /* saved recurring pills in wizard */
        .wiz-rec-pills { margin-top:12px; }
        .wiz-rec-pill {
            display:flex; align-items:center; justify-content:space-between;
            background:rgba(102,126,234,.1); border:1px solid rgba(102,126,234,.2);
            border-radius:6px; padding:8px 11px; margin-bottom:6px;
            font-size:13px;
        }
        .wiz-rec-pill .wp-left { display:flex; align-items:center; gap:8px; }
        .wiz-rec-pill .wp-dot { width:8px; height:8px; background:var(--meeting); border-radius:50%; }
        .wiz-rec-pill .wp-rm {
            background:none; border:none; color:var(--muted); cursor:pointer;
            font-size:14px; transition:color .2s;
        }
        .wiz-rec-pill .wp-rm:hover { color:var(--danger); }

        /* chart */
        .chart-box {
            background:var(--card); border:1px solid var(--border);
            border-radius:10px; padding:20px; margin-bottom:24px;
        }
        .chart-box-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; margin-bottom:14px; }
        .chart-wrap { display:flex; align-items:center; justify-content:center; }
        .chart-legend { margin-top:16px; }
        .leg-row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; font-size:13px; }
        .leg-left { display:flex; align-items:center; gap:9px; }
        .leg-dot { width:11px; height:11px; border-radius:3px; }
        .leg-name { color:var(--muted); }
        .leg-val { font-weight:700; font-family:'DM Mono',monospace; font-size:12px; }

        /* stats */
        .stats-box { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:18px 20px; }
        .st-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
        .st-label { color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
        .st-val { font-weight:700; font-family:'DM Mono',monospace; font-size:14px; }
        .st-div { height:1px; background:var(--border); margin:7px 0; }
        .alert { border-radius:6px; padding:11px 13px; margin-top:12px; font-size:12px; font-weight:600; }
        .alert-warn { background:#1a0e00; border:1px solid var(--admin); color:var(--admin); }
        .alert-ok   { background:#0a1a0a; border:1px solid var(--task);  color:var(--task); }

        /* grid */
        .main-area { padding:32px 28px; overflow-y:auto; }
        .week-grid { display:grid; gap:14px; margin-bottom:36px; }

        .day-col {
            background:var(--card); border:1px solid var(--border);
            border-radius:10px; padding:18px; min-height:380px;
            transition:border-color .2s, background .2s;
        }
        .day-col.drag-over { border-color:#555; background:var(--card-hover); }
        .day-col-hdr {
            font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px;
            padding:10px 12px; margin:-18px -18px 14px;
            background:rgba(255,255,255,.03); border-bottom:1px solid var(--border);
            border-radius:10px 10px 0 0;
        }

        .time-wrap { background:#000; border:1px solid var(--border); border-radius:6px; padding:10px 12px; margin-bottom:16px; }
        .time-top { display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px; }
        .time-used { font-weight:600; }
        .time-free { font-weight:700; }
        .time-free.ok  { color:var(--text); }
        .time-free.warn{ color:var(--admin); }
        .time-free.over{ color:var(--danger); }
        .tbar { height:6px; background:var(--border); border-radius:3px; overflow:hidden; }
        .tbar-fill { height:100%; background:var(--text); border-radius:3px; transition:width .3s,background .3s; }
        .tbar-fill.warn{ background:var(--admin); }
        .tbar-fill.over{ background:var(--danger); }

        /* PTO full-day banner */
        .pto-banner {
            background:rgba(102,102,102,.15); border:1px solid rgba(102,102,102,.3);
            border-radius:6px; padding:10px 12px; margin-bottom:10px;
            text-align:center;
        }
        .pto-banner .pto-label { font-size:13px; font-weight:700; color:var(--pto); text-transform:uppercase; letter-spacing:.8px; }
        .pto-banner .pto-sub { font-size:11px; color:var(--muted); margin-top:2px; }
        .pto-banner .pto-rm { background:none; border:none; color:var(--muted); font-size:10px; font-weight:700; cursor:pointer; font-family:inherit; text-transform:uppercase; letter-spacing:.5px; margin-top:4px; display:block; transition:color .2s; }
        .pto-banner .pto-rm:hover { color:var(--danger); }

        /* items */
        .item {
            background:var(--card-hover); border:1px solid var(--border);
            border-left:3px solid var(--meeting); border-radius:6px;
            padding:11px 13px; margin-bottom:9px; cursor:grab;
            transition:background .15s, transform .15s;
            position:relative;
        }
        .item:hover { background:#1e1e1e; transform:translateX(2px); }
        .item:active { cursor:grabbing; }
        .item.dragging { opacity:.35; }
        .item.task  { border-left-color:var(--task); }
        .item.admin { border-left-color:var(--admin); }
        .item.pto   { border-left-color:var(--pto); }
        .item.done  { opacity:.4; }
        .item.done .item-name { text-decoration:line-through; }

        .item-top { display:flex; align-items:flex-start; gap:9px; }

        /* #8 custom checkbox */
        .item-cb {
            -webkit-appearance:none; appearance:none;
            margin-top:3px; width:16px; height:16px; flex-shrink:0;
            border:2px solid #444; border-radius:4px;
            background:transparent; cursor:pointer;
            transition:background .15s, border-color .15s;
            position:relative;
        }
        .item-cb:hover { border-color:#666; }
        .item-cb:checked { background:var(--task); border-color:var(--task); }
        .item-cb:checked::after {
            content:''; position:absolute; left:4px; top:1px;
            width:5px; height:9px; border:solid #fff;
            border-width:0 2px 2px 0; transform:rotate(45deg);
        }

        .item-inner { flex:1; min-width:0; }
        .item-name { font-size:14px; font-weight:600; margin-bottom:2px; }
        .item-meta { font-size:11px; color:var(--muted); }

        /* #5 remove button ‚Äî hidden until card hover */
        .item-rm {
            background:none; border:none; color:var(--muted); cursor:pointer;
            font-size:10px; font-weight:700; text-transform:uppercase;
            letter-spacing:.5px; font-family:inherit; transition:color .2s, opacity .15s;
            position:absolute; top:10px; right:11px;
            opacity:0; pointer-events:none;
        }
        .item:hover .item-rm { opacity:1; pointer-events:auto; }
        .item-rm:hover { color:var(--danger); }

        /* recurring badge on confirmed items */
        .rec-badge {
            display:inline-block; font-size:9px; font-weight:700;
            background:rgba(102,126,234,.2); color:var(--meeting);
            padding:1px 5px; border-radius:3px; margin-left:5px;
            text-transform:uppercase; letter-spacing:.4px;
        }

        /* summary */
        .summary-box { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:28px; }
        .summary-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
        .summary-top h3 { font-size:18px; font-weight:700; letter-spacing:-.3px; }
        .copy-btn {
            background:var(--text); color:#000; border:none; padding:9px 18px;
            border-radius:6px; font-size:11px; font-weight:700; cursor:pointer;
            font-family:inherit; text-transform:uppercase; letter-spacing:.8px; transition:all .2s;
        }
        .copy-btn:hover { background:#e5e5e5; transform:translateY(-1px); }
        .summary-out {
            background:#000; border:1px solid var(--border); border-radius:6px;
            padding:22px; font-family:'DM Mono',monospace; font-size:13px;
            line-height:1.9; color:var(--text); white-space:pre-wrap; min-height:110px;
        }
        .summary-ph { color:#555; font-style:italic; font-family:'DM Sans',sans-serif; }

        /* ‚îÄ‚îÄ‚îÄ unified add form ‚Äî category pills ‚îÄ‚îÄ‚îÄ */
        .cat-pills { display:flex; gap:6px; margin-bottom:14px; }
        .cat-pill {
            flex:1; padding:8px 4px; border-radius:6px; text-align:center;
            font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.5px;
            cursor:pointer; border:1px solid var(--border); background:var(--card);
            color:var(--muted); transition:all .15s; font-family:inherit;
        }
        .cat-pill:hover { border-color:#444; color:var(--text); }
        .cat-pill.active-meeting { border-color:var(--meeting); background:rgba(102,126,234,.12); color:var(--meeting); }
        .cat-pill.active-task    { border-color:var(--task);    background:rgba(72,187,120,.12);  color:var(--task); }
        .cat-pill.active-admin   { border-color:var(--admin);   background:rgba(246,173,85,.12);  color:var(--admin); }
        .cat-pill.active-pto     { border-color:var(--pto);     background:rgba(102,102,102,.18); color:#aaa; }

        .hidden { display:none !important; }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ WIZARD ‚îÄ‚îÄ -->
<div class="overlay" id="wizardOverlay">
  <div class="panel">
    <div class="progress-bar"><div class="progress-fill" id="wProg" style="width:20%"></div></div>
    <div class="panel-body">

      <!-- 1: Welcome -->
      <div class="step active" id="s1">
        <span class="step-emoji">üëã</span>
        <h2>Welcome to Weekly Planner</h2>
        <p>Let's set up your planner in about 30 seconds. A few quick questions about how you work ‚Äî and we'll calculate your real available hours.</p>
        <div class="nav-row"><span class="indicator">1 of 5</span><button class="btn-solid" onclick="goStep(2)">Let's Go</button></div>
      </div>

      <!-- 2: Work hours -->
      <div class="step" id="s2">
        <span class="step-emoji">üïò</span>
        <h2>When do you work?</h2>
        <p>Set your typical start and end times. We'll subtract breaks in the next step.</p>
        <div class="irow"><div class="icon">üåÖ</div><div class="lbl">Day starts at<small>Usual start time</small></div><input type="time" id="wStart" value="09:00"></div>
        <div class="irow"><div class="icon">üåÜ</div><div class="lbl">Day ends at<small>Usual end time</small></div><input type="time" id="wEnd" value="17:00"></div>
        <div class="nav-row"><span class="indicator">2 of 5</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(1)">Back</button><button class="btn-solid" onclick="goStep(3)">Next</button></div></div>
      </div>

      <!-- 3: Breaks -->
      <div class="step" id="s3">
        <span class="step-emoji">‚òï</span>
        <h2>How do you take breaks?</h2>
        <p>Be real here ‚Äî a planner only works if the math is honest.</p>
        <div class="irow"><div class="icon">üçΩÔ∏è</div><div class="lbl">Lunch break<small>How long, usually?</small></div><input type="number" id="wLunch" value="30" min="0" max="120" step="5"><span class="unit">min</span></div>
        <div class="irow"><div class="icon">üõãÔ∏è</div><div class="lbl">Short breaks per day<small>Coffee, walk, stretch‚Ä¶</small></div><input type="number" id="wBreakCt" value="2" min="0" max="10" step="1"><span class="unit">breaks</span></div>
        <div class="irow"><div class="icon">‚è±Ô∏è</div><div class="lbl">Each break is<small>Average length</small></div><input type="number" id="wBreakLen" value="15" min="5" max="60" step="5"><span class="unit">min</span></div>
        <div class="nav-row"><span class="indicator">3 of 5</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(2)">Back</button><button class="btn-solid" onclick="goStep(4)">Next</button></div></div>
      </div>

      <!-- 4: Work days -->
      <div class="step" id="s4">
        <span class="step-emoji">üìÖ</span>
        <h2>Which days do you work?</h2>
        <p>Tap to toggle the days you plan around.</p>
        <div class="days-grid" id="wDaysGrid"></div>
        <div class="calc-box"><div class="big" id="wCalcNum">32.5h</div><div class="desc"><strong>Available this week</strong>After lunch &amp; breaks</div></div>
        <div class="nav-row"><span class="indicator">4 of 5</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(3)">Back</button><button class="btn-solid" onclick="goStep(5)">Next</button></div></div>
      </div>

      <!-- 5: Recurring meetings (skippable) -->
      <div class="step" id="s5">
        <span class="step-emoji">üîÅ</span>
        <h2>Any recurring meetings?</h2>
        <p>Add meetings that happen every week ‚Äî or every other week. They'll show up as suggestions each week. You can always skip this and add them later.</p>
        <div class="wiz-rec-form">
          <div class="wr-row">
            <input class="wr-name" type="text" id="wrName" placeholder="e.g. Team standup">
            <input class="wr-dur" type="number" id="wrDur" value="0.5" step="0.5" min="0.5">
          </div>
          <div class="wr-row">
            <select id="wrDay"></select>
            <select id="wrCadence">
              <option value="weekly">Every week</option>
              <option value="biweekly">Every other week</option>
              <option value="monthly">Once a month</option>
            </select>
            <select id="wrMonthDay" class="hidden" style="width:80px;">
              <!-- populated dynamically -->
            </select>
            <button class="wr-add" onclick="wizAddRecurring()">+ Add</button>
          </div>
        </div>
        <div class="wiz-rec-pills" id="wizRecPills"></div>
        <div class="nav-row"><span class="indicator">5 of 5</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(4)">Back</button><button class="btn-solid" onclick="wizardDone()">Start Planning</button></div></div>
      </div>

    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ -->
<div class="overlay hidden" id="settingsOverlay">
  <div class="panel" style="max-height:88vh;overflow-y:auto;">
    <div class="settings-header"><h2>Settings</h2><button class="close-btn" onclick="closeSettings()">‚úï</button></div>
    <div class="settings-body">
      <div class="settings-label">Work Hours</div>
      <div class="irow"><div class="icon">üåÖ</div><div class="lbl">Day starts at</div><input type="time" id="sStart"></div>
      <div class="irow"><div class="icon">üåÜ</div><div class="lbl">Day ends at</div><input type="time" id="sEnd"></div>
      <div class="settings-label">Breaks</div>
      <div class="irow"><div class="icon">üçΩÔ∏è</div><div class="lbl">Lunch break</div><input type="number" id="sLunch" min="0" max="120" step="5"><span class="unit">min</span></div>
      <div class="irow"><div class="icon">üõãÔ∏è</div><div class="lbl">Short breaks per day</div><input type="number" id="sBreakCt" min="0" max="10" step="1"><span class="unit">breaks</span></div>
      <div class="irow"><div class="icon">‚è±Ô∏è</div><div class="lbl">Each break is</div><input type="number" id="sBreakLen" min="5" max="60" step="5"><span class="unit">min</span></div>
      <div class="settings-label">Work Days</div>
      <div class="days-grid" id="sDaysGrid"></div>
      <div class="calc-box"><div class="big" id="sCalcNum">32.5h</div><div class="desc"><strong>Available this week</strong>After lunch &amp; breaks</div></div>
      <button class="btn-solid" style="width:100%;margin-top:24px;" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ APP ‚îÄ‚îÄ -->
<div class="app" id="app">
  <div class="header">
    <h1>Weekly Planner</h1>
    <div class="hdr-btns">
      <button class="btn-hdr" onclick="openSettings()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Settings
      </button>
      <button class="btn-hdr danger" onclick="resetWeek()">Reset Week</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="chart-box">
        <div class="chart-box-title">Time Breakdown</div>
        <div class="chart-wrap"><canvas id="pieChart" width="170" height="170"></canvas></div>
        <div class="chart-legend" id="chartLeg"></div>
      </div>

      <!-- Recurring (manage) -->
      <div class="sec-title"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> Recurring</div>
      <div id="recChips"></div>
      <!-- biweekly parity row, shown only when biweekly recurrings exist -->
      <div id="parityRow" class="hidden parity-row">
        <span>Bi-weekly phase off?</span>
        <button class="parity-btn" onclick="flipParity()">Flip</button>
      </div>
      <!-- add-new form in sidebar -->
      <div class="wiz-rec-form" style="margin-top:8px;">
        <div class="wr-row">
          <input class="wr-name" type="text" id="sRecName" placeholder="New recurring‚Ä¶">
          <input class="wr-dur" type="number" id="sRecDur" value="0.5" step="0.5" min="0.5">
        </div>
        <div class="wr-row">
          <select id="sRecDay"></select>
          <select id="sRecCadence" onchange="onSidebarCadenceChange()">
            <option value="weekly">Every week</option>
            <option value="biweekly">Every other week</option>
            <option value="monthly">Once a month</option>
          </select>
          <select id="sRecMonthDay" class="hidden" style="width:80px;"></select>
          <button class="wr-add" onclick="sidebarAddRecurring()">+ Add</button>
        </div>
      </div>
      <div class="divider"></div>

      <!-- Unified Add Item -->
      <div class="sec-title"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> Add Item</div>
      <div class="cat-pills" id="catPills">
        <button class="cat-pill active-meeting" data-cat="meetings" onclick="setCat('meetings')">Meeting</button>
        <button class="cat-pill" data-cat="tasks" onclick="setCat('tasks')">Task</button>
        <button class="cat-pill" data-cat="admin" onclick="setCat('admin')">Admin</button>
        <button class="cat-pill" data-cat="pto" onclick="setCat('pto')">PTO</button>
      </div>
      <div class="ig"><label>Name</label><input type="text" id="uName" placeholder="e.g. Team standup"></div>
      <div id="fullDayToggleWrap" class="hidden">
        <div class="fullday-row" id="fullDayRow" onclick="toggleFullDay()">
          <div class="toggle-track" id="fullDayTrack"><div class="knob"></div></div>
          <div class="fullday-label">Full day<small>Blocks the entire day</small></div>
        </div>
      </div>
      <div class="row2" id="uDayHourRow">
        <div class="ig"><label>Day</label><select id="uDay"></select></div>
        <div class="ig" id="uHoursWrap"><label>Hours</label><input type="number" id="uDur" value="0.5" step="0.5" min="0.5"></div>
      </div>
      <button class="add-btn" id="uAddBtn" onclick="addUnified()">Add Meeting</button>
      <div class="divider"></div>

      <div class="stats-box" id="statsBox"></div>
    </div>

    <div class="main-area">
      <!-- suggestions tray lives here, rendered dynamically -->
      <div id="suggestionsTray"></div>
      <div class="week-grid" id="weekGrid"></div>
      <div class="summary-box">
        <div class="summary-top"><h3>Weekly Summary</h3><button class="copy-btn" onclick="copySummary()">Copy</button></div>
        <div class="summary-out" id="summaryOut"><span class="summary-ph">Check off completed items to build your weekly summary‚Ä¶</span></div>
      </div>
    </div>
  </div>
</div>

<script>
const ALL_DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const MONTH_DAYS=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28];

/* ‚îÄ‚îÄ state ‚îÄ‚îÄ */
let cfg={
    start:'09:00', end:'17:00', lunch:30, breakCt:2, breakLen:15,
    days:['Monday','Tuesday','Wednesday','Thursday','Friday'],
    recurring:[],        // [{id, name, duration, day, cadence, monthDay, biweeklyPhase}]
    parityFlip:false     // global flip for biweekly parity
};
let data={};             // per-day week data
let weekState={};        // { weekKey: { dismissed:[id‚Ä¶], confirmed:[id‚Ä¶] } }
let drag=null;
let isFullDay=false;

/* ‚îÄ‚îÄ helpers ‚îÄ‚îÄ */
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function dayHours(){
    const [sh,sm]=cfg.start.split(':').map(Number);
    const [eh,em]=cfg.end.split(':').map(Number);
    return Math.max(0,((eh*60+em)-(sh*60+sm))-cfg.lunch-cfg.breakCt*cfg.breakLen)/60;
}
function weekHours(){ return dayHours()*cfg.days.length; }

/* weekKey = ISO date string of this week's Monday */
function getMonday(d){
    const date=new Date(d); date.setHours(0,0,0,0);
    const day=date.getDay(); const diff=date.getDate()-(day===0?-6:day-1);
    date.setDate(diff); return date;
}
function thisWeekKey(){
    const m=getMonday(new Date());
    return m.toISOString().slice(0,10); // "2026-02-02"
}

/* ‚îÄ‚îÄ recurring logic ‚îÄ‚îÄ */
function isRecurringDueThisWeek(rec){
    const wk=thisWeekKey();
    const monday=new Date(wk+'T00:00:00');

    if(rec.cadence==='weekly') return true;

    if(rec.cadence==='biweekly'){
        // epoch monday = 2024-01-01 (a Monday). Count weeks from there.
        const epoch=new Date('2024-01-01T00:00:00');
        const weeksSinceEpoch=Math.round((monday-epoch)/(7*24*60*60*1000));
        // phase 0 = even weeks, phase 1 = odd weeks
        const phase=weeksSinceEpoch%2;
        const recPhase=rec.biweeklyPhase||0;
        const effectivePhase=cfg.parityFlip? (1-recPhase) : recPhase;
        return phase===effectivePhase;
    }

    if(rec.cadence==='monthly'){
        // due if the month of this week contains the monthDay
        // and the monthDay falls within Mon-Sun of this week
        const md=rec.monthDay||1;
        // check each day Mon-Sun
        for(let i=0;i<7;i++){
            const d=new Date(monday); d.setDate(monday.getDate()+i);
            if(d.getDate()===md){
                // map JS day name to our day name and check it's in cfg.days
                const dayName=ALL_DAYS[i]; // Mon=0..Sun=6
                if(cfg.days.includes(dayName)) return true;
            }
        }
        return false;
    }
    return false;
}

function getDayForRecurring(rec){
    if(rec.cadence==='monthly'){
        // find which day of the week the monthDay lands on this week
        const monday=new Date(thisWeekKey()+'T00:00:00');
        const md=rec.monthDay||1;
        for(let i=0;i<7;i++){
            const d=new Date(monday); d.setDate(monday.getDate()+i);
            if(d.getDate()===md) return ALL_DAYS[i];
        }
        return rec.day; // fallback
    }
    return rec.day;
}

function getPendingSuggestions(){
    const wk=thisWeekKey();
    const ws=weekState[wk]||{dismissed:[],confirmed:[]};
    return cfg.recurring.filter(r=>{
        if(ws.dismissed.includes(r.id)) return false;
        if(ws.confirmed.includes(r.id)) return false;
        return isRecurringDueThisWeek(r);
    });
}

function confirmSuggestion(id){
    const wk=thisWeekKey();
    if(!weekState[wk]) weekState[wk]={dismissed:[],confirmed:[]};
    weekState[wk].confirmed.push(id);
    // actually add to day data
    const rec=cfg.recurring.find(r=>r.id===id);
    if(!rec) return;
    const day=getDayForRecurring(rec);
    if(!data[day]) data[day]={meetings:[],tasks:[],other:[]};
    data[day].meetings.push({name:rec.name, duration:rec.duration, completed:false, recurringId:id});
    save(); render();
}

function dismissSuggestion(id){
    const wk=thisWeekKey();
    if(!weekState[wk]) weekState[wk]={dismissed:[],confirmed:[]};
    weekState[wk].dismissed.push(id);
    save(); render();
}

/* ‚îÄ‚îÄ persistence ‚îÄ‚îÄ */
function ensureData(){
    cfg.days.forEach(d=>{
        if(!data[d]) data[d]={meetings:[],tasks:[],other:[]};
        if(!data[d].meetings) data[d].meetings=[];
        if(!data[d].tasks)    data[d].tasks=[];
        if(!data[d].other)    data[d].other=[];
        if(data[d].admin){
            data[d].admin.forEach(i=>{
                data[d].other.push({name:i.name,duration:i.duration,completed:i.completed||false,subtype:'admin',fullDay:false});
            });
            delete data[d].admin;
        }
    });
    Object.keys(data).forEach(d=>{
        if(!data[d].other) data[d].other=[];
        if(data[d].admin){
            data[d].admin.forEach(i=>{
                data[d].other.push({name:i.name,duration:i.duration,completed:i.completed||false,subtype:'admin',fullDay:false});
            });
            delete data[d].admin;
        }
    });
    if(!cfg.recurring) cfg.recurring=[];
    if(cfg.parityFlip===undefined) cfg.parityFlip=false;
}
function save(){
    localStorage.setItem('wp_cfg',JSON.stringify(cfg));
    localStorage.setItem('wp_data',JSON.stringify(data));
    localStorage.setItem('wp_weekState',JSON.stringify(weekState));
}

/* ‚îÄ‚îÄ boot ‚îÄ‚îÄ */
(function boot(){
    try {
        const c=localStorage.getItem('wp_cfg');
        if(c){
            cfg=JSON.parse(c);
            data=JSON.parse(localStorage.getItem('wp_data')||'{}');
            weekState=JSON.parse(localStorage.getItem('wp_weekState')||'{}');
            ensureData();
            document.getElementById('wizardOverlay').classList.add('hidden');
            showApp();
        } else {
            renderDaysToggle('wDaysGrid');
            updCalc('wCalcNum');
            populateMonthDaySelect('wrMonthDay');
            fillWizRecDaySelect();
        }
    } catch(e){
        console.error('Boot error, resetting:',e);
        localStorage.removeItem('wp_cfg');
        localStorage.removeItem('wp_data');
        localStorage.removeItem('wp_weekState');
        data={}; weekState={};
        cfg={start:'09:00',end:'17:00',lunch:30,breakCt:2,breakLen:15,days:['Monday','Tuesday','Wednesday','Thursday','Friday'],recurring:[],parityFlip:false};
        renderDaysToggle('wDaysGrid');
        updCalc('wCalcNum');
        populateMonthDaySelect('wrMonthDay');
        fillWizRecDaySelect();
    }
})();

/* ‚îÄ‚îÄ days toggle ‚îÄ‚îÄ */
function renderDaysToggle(id){
    const el=document.getElementById(id); el.innerHTML='';
    ALL_DAYS.forEach(d=>{
        const on=cfg.days.includes(d);
        const t=document.createElement('div');
        t.className='day-tog'+(on?' on':'');
        t.innerHTML=`<div class="dlbl">${d.slice(0,3)}</div>`;
        t.onclick=()=>{
            if(cfg.days.includes(d)){ if(cfg.days.length>1) cfg.days=cfg.days.filter(x=>x!==d); }
            else { cfg.days.push(d); cfg.days.sort((a,b)=>ALL_DAYS.indexOf(a)-ALL_DAYS.indexOf(b)); }
            renderDaysToggle(id);
            updCalc(id==='wDaysGrid'?'wCalcNum':'sCalcNum');
        };
        el.appendChild(t);
    });
}
function updCalc(id){ document.getElementById(id).textContent=weekHours().toFixed(1)+'h'; }

/* ‚îÄ‚îÄ month day select helper ‚îÄ‚îÄ */
function ordinal(n){
    const s=['th','st','nd','rd'], v=n%100;
    return n+(s[(v-20)%10]||s[v]||s[0]);
}
function populateMonthDaySelect(selectId){
    const s=document.getElementById(selectId);
    if(!s) return;
    s.innerHTML=MONTH_DAYS.map(n=>`<option value="${n}">${ordinal(n)}</option>`).join('');
}

/* ‚îÄ‚îÄ wizard day select for recurring ‚îÄ‚îÄ */
function fillWizRecDaySelect(){
    const s=document.getElementById('wrDay');
    if(!s) return;
    s.innerHTML='';
    cfg.days.forEach(d=> s.innerHTML+=`<option value="${d}">${d}</option>`);
}

/* ‚îÄ‚îÄ wizard ‚îÄ‚îÄ */
function goStep(n){
    if(n>=3){ cfg.start=document.getElementById('wStart').value; cfg.end=document.getElementById('wEnd').value; }
    if(n>=4){ cfg.lunch=+document.getElementById('wLunch').value||30; cfg.breakCt=+document.getElementById('wBreakCt').value||0; cfg.breakLen=+document.getElementById('wBreakLen').value||15; updCalc('wCalcNum'); }
    if(n>=5){
        // refresh the day select in the recurring form in case days changed on step 4
        fillWizRecDaySelect();
        renderWizRecPills();
    }
    document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');
    document.getElementById('wProg').style.width=(n*20)+'%'; // 5 steps
}

/* cadence change handler in wizard */
document.addEventListener('DOMContentLoaded',()=>{
    const wrCad=document.getElementById('wrCadence');
    if(wrCad) wrCad.addEventListener('change',()=>{
        const isMonthly=wrCad.value==='monthly';
        document.getElementById('wrMonthDay').classList.toggle('hidden',!isMonthly);
    });
});

function calcBiweeklyPhase(){
    const monday=getMonday(new Date());
    const epoch=new Date('2024-01-01T00:00:00');
    const weeksSinceEpoch=Math.round((monday-epoch)/(7*24*60*60*1000));
    return weeksSinceEpoch%2; // 0 or 1 ‚Äî matches the phase check in isRecurringDueThisWeek
}

function wizAddRecurring(){
    const name=document.getElementById('wrName').value.trim();
    const dur=parseFloat(document.getElementById('wrDur').value);
    const day=document.getElementById('wrDay').value;
    const cadence=document.getElementById('wrCadence').value;
    const monthDay=cadence==='monthly'? +document.getElementById('wrMonthDay').value : undefined;
    if(!name||!dur) return;

    cfg.recurring.push({
        id:uid(), name, duration:dur, day, cadence, monthDay,
        biweeklyPhase: cadence==='biweekly' ? calcBiweeklyPhase() : undefined
    });
    // reset form
    document.getElementById('wrName').value='';
    document.getElementById('wrDur').value='0.5';
    renderWizRecPills();
}

function wizRemoveRecurring(id){
    cfg.recurring=cfg.recurring.filter(r=>r.id!==id);
    renderWizRecPills();
}

function renderWizRecPills(){
    const el=document.getElementById('wizRecPills');
    if(!el) return;
    el.innerHTML=cfg.recurring.map(r=>{
        const cadLabel=r.cadence==='weekly'?'Weekly':r.cadence==='biweekly'?'Every other week':`Monthly (${r.monthDay}th)`;
        return `<div class="wiz-rec-pill">
            <div class="wp-left"><div class="wp-dot"></div><span>${r.name} ¬∑ ${r.duration}h ¬∑ ${r.day} ¬∑ ${cadLabel}</span></div>
            <button class="wp-rm" onclick="wizRemoveRecurring('${r.id}')">‚úï</button>
        </div>`;
    }).join('');
}

function wizardDone(){ ensureData(); save(); document.getElementById('wizardOverlay').classList.add('hidden'); showApp(); }

/* ‚îÄ‚îÄ settings ‚îÄ‚îÄ */
function openSettings(){
    document.getElementById('sStart').value=cfg.start;
    document.getElementById('sEnd').value=cfg.end;
    document.getElementById('sLunch').value=cfg.lunch;
    document.getElementById('sBreakCt').value=cfg.breakCt;
    document.getElementById('sBreakLen').value=cfg.breakLen;
    renderDaysToggle('sDaysGrid'); updCalc('sCalcNum');
    document.getElementById('settingsOverlay').classList.remove('hidden');
}
function closeSettings(){ document.getElementById('settingsOverlay').classList.add('hidden'); }
function saveSettings(){
    cfg.start=document.getElementById('sStart').value;
    cfg.end=document.getElementById('sEnd').value;
    cfg.lunch=+document.getElementById('sLunch').value||30;
    cfg.breakCt=+document.getElementById('sBreakCt').value||0;
    cfg.breakLen=+document.getElementById('sBreakLen').value||15;
    ensureData(); save(); closeSettings(); fillSelects(); render();
}

/* ‚îÄ‚îÄ sidebar recurring ‚îÄ‚îÄ */
function onSidebarCadenceChange(){
    const isMonthly=document.getElementById('sRecCadence').value==='monthly';
    document.getElementById('sRecMonthDay').classList.toggle('hidden',!isMonthly);
}

function sidebarAddRecurring(){
    const name=document.getElementById('sRecName').value.trim();
    const dur=parseFloat(document.getElementById('sRecDur').value);
    const day=document.getElementById('sRecDay').value;
    const cadence=document.getElementById('sRecCadence').value;
    const monthDay=cadence==='monthly'? +document.getElementById('sRecMonthDay').value : undefined;
    if(!name||!dur) return;
    cfg.recurring.push({
        id:uid(), name, duration:dur, day, cadence, monthDay,
        biweeklyPhase: cadence==='biweekly' ? calcBiweeklyPhase() : undefined
    });
    document.getElementById('sRecName').value='';
    document.getElementById('sRecDur').value='0.5';
    save(); render();
}

function deleteRecurring(id){
    cfg.recurring=cfg.recurring.filter(r=>r.id!==id);
    // also clean weekState refs
    Object.keys(weekState).forEach(wk=>{
        if(weekState[wk].confirmed) weekState[wk].confirmed=weekState[wk].confirmed.filter(x=>x!==id);
        if(weekState[wk].dismissed) weekState[wk].dismissed=weekState[wk].dismissed.filter(x=>x!==id);
    });
    save(); render();
}

function flipParity(){
    cfg.parityFlip=!cfg.parityFlip;
    // clear this week's dismissed/confirmed so suggestions re-evaluate
    const wk=thisWeekKey();
    if(weekState[wk]){
        weekState[wk].dismissed=weekState[wk].dismissed.filter(id=>{
            const r=cfg.recurring.find(x=>x.id===id);
            return r && r.cadence!=='biweekly';
        });
        weekState[wk].confirmed=weekState[wk].confirmed.filter(id=>{
            const r=cfg.recurring.find(x=>x.id===id);
            return r && r.cadence!=='biweekly';
        });
        // remove biweekly meetings that were added this week from data
        cfg.days.forEach(d=>{
            if(data[d]&&data[d].meetings){
                data[d].meetings=data[d].meetings.filter(m=>{
                    if(!m.recurringId) return true;
                    const r=cfg.recurring.find(x=>x.id===m.recurringId);
                    return !(r&&r.cadence==='biweekly');
                });
            }
        });
    }
    save(); render();
}

/* ‚îÄ‚îÄ unified add form ‚îÄ‚îÄ */
let activeCat='meetings'; // meetings | tasks | admin | pto

function setCat(cat){
    activeCat=cat;
    // update pill highlights
    document.querySelectorAll('.cat-pill').forEach(p=>{
        p.className='cat-pill'; // reset
    });
    const activeClass={meetings:'active-meeting',tasks:'active-task',admin:'active-admin',pto:'active-pto'};
    const pill=document.querySelector(`.cat-pill[data-cat="${cat}"]`);
    if(pill) pill.classList.add(activeClass[cat]);
    // Full Day toggle: only show for PTO
    document.getElementById('fullDayToggleWrap').classList.toggle('hidden', cat!=='pto');
    if(cat!=='pto'){ isFullDay=false; syncFullDayUI(); }
    // button label
    const labels={meetings:'Add Meeting',tasks:'Add Task',admin:'Add Admin',pto:'Add PTO'};
    document.getElementById('uAddBtn').textContent=labels[cat];
    // placeholder
    const phs={meetings:'e.g. Team standup',tasks:'e.g. Write proposal',admin:'e.g. Email cleanup',pto:'e.g. Dentist appt'};
    document.getElementById('uName').placeholder=phs[cat];
}

function addUnified(){
    const name=document.getElementById('uName').value.trim();
    const day=document.getElementById('uDay').value;
    const dur=isFullDay?dayHours():parseFloat(document.getElementById('uDur').value);
    if(!name||!dur) return;

    if(activeCat==='meetings'){
        data[day].meetings.push({name,duration:dur,completed:false});
    } else if(activeCat==='tasks'){
        data[day].tasks.push({name,duration:dur,completed:false});
    } else {
        // admin or pto ‚Üí goes into other[]
        data[day].other.push({name,duration:dur,subtype:activeCat,fullDay:isFullDay,completed:false});
    }
    document.getElementById('uName').value='';
    document.getElementById('uDur').value='0.5';
    isFullDay=false; syncFullDayUI();
    save(); render();
}

function toggleFullDay(){ isFullDay=!isFullDay; syncFullDayUI(); }
function syncFullDayUI(){
    document.getElementById('fullDayTrack').classList.toggle('on',isFullDay);
    document.getElementById('fullDayRow').classList.toggle('active',isFullDay);
    document.getElementById('uHoursWrap').classList.toggle('hidden',isFullDay);
}

function removeItem(day,type,i){ data[day][type].splice(i,1); save(); render(); }
function toggleDone(day,type,i){ data[day][type][i].completed=!data[day][type][i].completed; save(); render(); }

/* ‚îÄ‚îÄ drag ‚îÄ‚îÄ */
function dStart(e,day,type,i){ drag={day,type,i}; e.currentTarget.classList.add('dragging'); }
function dEnd(e){ e.currentTarget.classList.remove('dragging'); document.querySelectorAll('.day-col').forEach(c=>c.classList.remove('drag-over')); }
function dOver(e){ e.preventDefault(); }
function dEnter(e){ e.currentTarget.classList.add('drag-over'); }
function dLeave(e){ e.currentTarget.classList.remove('drag-over'); }
function dDrop(e,target){
    e.preventDefault(); e.currentTarget.classList.remove('drag-over');
    if(!drag||drag.day===target) return;
    const item=data[drag.day][drag.type].splice(drag.i,1)[0];
    if(item.fullDay) item.duration=dayHours();
    if(!data[target]) data[target]={meetings:[],tasks:[],other:[]};
    data[target][drag.type].push(item);
    drag=null; save(); render();
}

/* ‚îÄ‚îÄ populate selects ‚îÄ‚îÄ */
function fillSelects(){
    ['uDay','sRecDay'].forEach(id=>{
        const s=document.getElementById(id);
        if(!s) return;
        s.innerHTML='';
        cfg.days.forEach(d=>s.innerHTML+=`<option value="${d}">${d}</option>`);
    });
    populateMonthDaySelect('sRecMonthDay');
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function showApp(){
    document.getElementById('app').classList.add('on');
    fillSelects();
    setCat(activeCat); // initialise unified form pill/label/placeholder
    setTimeout(()=>render(),0);
}
function render(){ renderSuggestions(); renderRecChips(); renderGrid(); renderPie(); renderStats(); renderSummary(); }

/* ‚îÄ‚îÄ suggestions tray ‚îÄ‚îÄ */
function renderSuggestions(){
    const el=document.getElementById('suggestionsTray');
    const pending=getPendingSuggestions();
    if(!pending.length){ el.innerHTML=''; return; }
    el.innerHTML=`<div class="suggestions-tray">
        <div class="suggestions-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Recurring this week
            <span class="s-count">${pending.length}</span>
        </div>
        ${pending.map(r=>{
            const day=getDayForRecurring(r);
            const cadLabel=r.cadence==='weekly'?'Weekly':r.cadence==='biweekly'?'Bi-weekly':`Monthly`;
            return `<div class="suggestion-item">
                <div class="si-inner">
                    <div class="si-name">${r.name}</div>
                    <div class="si-meta">${r.duration}h ¬∑ ${day} ¬∑ ${cadLabel}</div>
                </div>
                <div class="si-btns">
                    <button class="si-btn add" onclick="confirmSuggestion('${r.id}')">Add</button>
                    <button class="si-btn skip" onclick="dismissSuggestion('${r.id}')">Skip</button>
                </div>
            </div>`;
        }).join('')}
    </div>`;
}

/* ‚îÄ‚îÄ recurring chips in sidebar ‚îÄ‚îÄ */
function renderRecChips(){
    const el=document.getElementById('recChips');
    el.innerHTML=cfg.recurring.map(r=>{
        const cadLabel=r.cadence==='weekly'?'Weekly':r.cadence==='biweekly'?'Every other week':`Monthly (${r.monthDay}th)`;
        return `<div class="rec-chip">
            <div class="rc-inner">
                <div class="rc-name">${r.name}</div>
                <div class="rc-meta">${r.duration}h ¬∑ ${r.day} ¬∑ ${cadLabel}</div>
            </div>
            <button class="rc-del" onclick="deleteRecurring('${r.id}')">‚úï</button>
        </div>`;
    }).join('');
    // show/hide parity row
    const hasBiweekly=cfg.recurring.some(r=>r.cadence==='biweekly');
    document.getElementById('parityRow').classList.toggle('hidden',!hasBiweekly);
}

/* ‚îÄ‚îÄ grid ‚îÄ‚îÄ */
function renderGrid(){
    const g=document.getElementById('weekGrid');
    g.style.gridTemplateColumns=`repeat(${cfg.days.length},1fr)`;
    g.innerHTML='';
    const dh=dayHours();

    cfg.days.forEach(day=>{
        const M=data[day]?.meetings||[];
        const T=data[day]?.tasks||[];
        const O=data[day]?.other||[];

        const fullDayPTO=O.filter(i=>i.fullDay&&i.subtype==='pto');
        const used=[...M,...T,...O].reduce((s,i)=>s+i.duration,0);
        const free=dh-used;
        const pct=Math.min((used/dh)*100,100);
        const barCls=used>dh?'over':pct>80?'warn':'';
        const freeCls=free<0?'over':free<=dh*.2?'warn':'ok';

        const col=document.createElement('div');
        col.className='day-col';
        col.ondragover=dOver; col.ondragenter=dEnter; col.ondragleave=dLeave;
        col.ondrop=e=>dDrop(e,day);

        let items='';

        // full-day PTO banners
        fullDayPTO.forEach(it=>{
            const realIdx=O.indexOf(it);
            items+=`<div class="pto-banner">
                <div class="pto-label">üèñÔ∏è PTO ‚Äî ${it.name}</div>
                <div class="pto-sub">Full day (${it.duration.toFixed(1)}h)</div>
                <button class="pto-rm" onclick="removeItem('${day}','other',${realIdx})">Remove</button>
            </div>`;
        });

        // meetings
        M.forEach((it,i)=>{
            const recBadge=it.recurringId?'<span class="rec-badge">recurring</span>':'';
            items+=`<div class="item ${it.completed?'done':''}" draggable ondragstart="dStart(event,'${day}','meetings',${i})" ondragend="dEnd(event)">
                <div class="item-top">
                    <input class="item-cb" type="checkbox" ${it.completed?'checked':''} onchange="toggleDone('${day}','meetings',${i})">
                    <div class="item-inner"><div class="item-name">${it.name}${recBadge}</div><div class="item-meta">${it.duration}h ¬∑ Meeting</div></div>
                </div>
                <button class="item-rm" onclick="removeItem('${day}','meetings',${i})">Remove</button>
            </div>`;
        });

        // tasks
        T.forEach((it,i)=>{
            items+=`<div class="item task ${it.completed?'done':''}" draggable ondragstart="dStart(event,'${day}','tasks',${i})" ondragend="dEnd(event)">
                <div class="item-top">
                    <input class="item-cb" type="checkbox" ${it.completed?'checked':''} onchange="toggleDone('${day}','tasks',${i})">
                    <div class="item-inner"><div class="item-name">${it.name}</div><div class="item-meta">${it.duration}h ¬∑ Task</div></div>
                </div>
                <button class="item-rm" onclick="removeItem('${day}','tasks',${i})">Remove</button>
            </div>`;
        });

        // other (admin/pto)
        O.forEach((it,i)=>{
            if(it.fullDay&&it.subtype==='pto') return;
            const label=it.subtype==='pto'?'PTO':'Admin';
            const colorCls=it.subtype==='pto'?'pto':'admin';
            items+=`<div class="item ${colorCls} ${it.completed?'done':''}" draggable ondragstart="dStart(event,'${day}','other',${i})" ondragend="dEnd(event)">
                <div class="item-top">
                    <input class="item-cb" type="checkbox" ${it.completed?'checked':''} onchange="toggleDone('${day}','other',${i})">
                    <div class="item-inner"><div class="item-name">${it.name}</div><div class="item-meta">${it.duration}h ¬∑ ${label}${it.fullDay?' ‚Äì Full Day':''}</div></div>
                </div>
                <button class="item-rm" onclick="removeItem('${day}','other',${i})">Remove</button>
            </div>`;
        });

        col.innerHTML=`
            <div class="day-col-hdr">${day}</div>
            <div class="time-wrap">
                <div class="time-top"><span class="time-used">${used.toFixed(1)}h used</span><span class="time-free ${freeCls}">${free>=0?free.toFixed(1)+'h free':Math.abs(free).toFixed(1)+'h over'}</span></div>
                <div class="tbar"><div class="tbar-fill ${barCls}" style="width:${pct}%"></div></div>
            </div>${items}`;
        g.appendChild(col);
    });
}

/* ‚îÄ‚îÄ pie ‚îÄ‚îÄ */
function renderPie(){
    const c=document.getElementById('pieChart'), ctx=c.getContext('2d');
    if(!ctx) return;
    ctx.clearRect(0,0,c.width,c.height);
    let M=0,T=0,A=0,P=0;
    cfg.days.forEach(d=>{
        (data[d]?.meetings||[]).forEach(i=>M+=i.duration);
        (data[d]?.tasks||[]).forEach(i=>T+=i.duration);
        (data[d]?.other||[]).forEach(i=>{ if(i.subtype==='pto') P+=i.duration; else A+=i.duration; });
    });
    const tot=M+T+A+P;
    const cx=c.width/2, cy=c.height/2, r=65;
    if(!tot){
        ctx.strokeStyle='#222'; ctx.lineWidth=14;
        ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
        document.getElementById('chartLeg').innerHTML='<div style="color:#555;text-align:center;font-size:12px;padding-top:6px;">No time logged yet</div>';
        return;
    }
    const slices=[
        {label:'Meetings',val:M,color:'#667eea'},
        {label:'Tasks',val:T,color:'#48bb78'},
        {label:'Admin',val:A,color:'#f6ad55'},
        {label:'PTO',val:P,color:'#666'}
    ].filter(s=>s.val>0);
    let ang=-Math.PI/2;
    slices.forEach(s=>{
        const sw=(s.val/tot)*Math.PI*2;
        ctx.fillStyle=s.color;
        ctx.beginPath(); ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,ang,ang+sw); ctx.closePath(); ctx.fill();
        ang+=sw;
    });
    ctx.fillStyle='#0a0a0a';
    ctx.beginPath(); ctx.arc(cx,cy,r-20,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#fff';
    ctx.font='700 15px "DM Mono",monospace';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(tot.toFixed(1)+'h',cx,cy);
    document.getElementById('chartLeg').innerHTML=slices.map(s=>
        `<div class="leg-row"><div class="leg-left"><div class="leg-dot" style="background:${s.color}"></div><span class="leg-name">${s.label}</span></div><span class="leg-val">${s.val.toFixed(1)}h</span></div>`
    ).join('');
}

/* ‚îÄ‚îÄ stats ‚îÄ‚îÄ */
function renderStats(){
    let M=0,T=0,A=0,P=0,over=0;
    const dh=dayHours();
    cfg.days.forEach(d=>{
        let u=0;
        (data[d]?.meetings||[]).forEach(i=>{M+=i.duration;u+=i.duration;});
        (data[d]?.tasks||[]).forEach(i=>{T+=i.duration;u+=i.duration;});
        (data[d]?.other||[]).forEach(i=>{ if(i.subtype==='pto'){P+=i.duration;}else{A+=i.duration;} u+=i.duration; });
        if(u>dh) over++;
    });
    const tot=M+T+A+P;
    document.getElementById('statsBox').innerHTML=`
        <div class="st-row"><span class="st-label">Meetings</span><span class="st-val">${M.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">Tasks</span><span class="st-val">${T.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">Admin</span><span class="st-val">${A.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">PTO</span><span class="st-val">${P.toFixed(1)}h</span></div>
        <div class="st-div"></div>
        <div class="st-row"><span class="st-label">Week Total</span><span class="st-val">${tot.toFixed(1)}h / ${weekHours().toFixed(1)}h</span></div>
        ${over>0?`<div class="alert alert-warn">‚ö†Ô∏è ${over} day(s) overbooked</div>`:tot>0?`<div class="alert alert-ok">‚úì Week balanced</div>`:''}`;
}

/* ‚îÄ‚îÄ summary ‚îÄ‚îÄ */
function renderSummary(){
    let lines=[],any=false,cM=0,cT=0,cA=0,cP=0;
    cfg.days.forEach(day=>{
        const dl=[];
        (data[day]?.meetings||[]).filter(i=>i.completed).forEach(i=>{
            const tag=i.recurringId?' [recurring]':'';
            dl.push(`  ‚Ä¢ ${i.name}${tag} (${i.duration}h)`);
            cM+=i.duration; any=true;
        });
        (data[day]?.tasks||[]).filter(i=>i.completed).forEach(i=>{dl.push(`  ‚Ä¢ ${i.name} (${i.duration}h)`);cT+=i.duration;any=true;});
        (data[day]?.other||[]).filter(i=>i.completed).forEach(i=>{
            const tag=i.subtype==='pto'?'PTO':'Admin';
            dl.push(`  ‚Ä¢ ${i.name} (${i.duration}h ¬∑ ${tag}${i.fullDay?' ‚Äì Full Day':''})`);
            if(i.subtype==='pto') cP+=i.duration; else cA+=i.duration;
            any=true;
        });
        if(dl.length){ lines.push(day.toUpperCase()); lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'); lines.push(...dl); lines.push(''); }
    });
    if(!any){ document.getElementById('summaryOut').innerHTML='<span class="summary-ph">Check off completed items to build your weekly summary‚Ä¶</span>'; return; }
    const cTot=cM+cT+cA+cP;
    lines.push('HOURS BREAKDOWN');
    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    lines.push(`  Meetings:     ${cM.toFixed(1)}h`);
    lines.push(`  Tasks:        ${cT.toFixed(1)}h`);
    lines.push(`  Admin:        ${cA.toFixed(1)}h`);
    lines.push(`  PTO:          ${cP.toFixed(1)}h`);
    lines.push(`  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
    lines.push(`  Total:        ${cTot.toFixed(1)}h`);
    document.getElementById('summaryOut').textContent=lines.join('\n');
}

function copySummary(){
    const el=document.getElementById('summaryOut');
    if(el.querySelector('.summary-ph')) return;
    navigator.clipboard.writeText(el.textContent).then(()=>{
        const b=document.querySelector('.copy-btn');
        b.textContent='Copied!'; setTimeout(()=>b.textContent='Copy',2000);
    });
}

/* ‚îÄ‚îÄ reset: clears one-offs + confirmed suggestions, but re-shows suggestions ‚îÄ‚îÄ */
function resetWeek(){
    if(!confirm('Clear this week? Recurring suggestions will reappear.')) return;
    // wipe day data
    data={}; ensureData();
    // wipe this week's state so suggestions come back
    const wk=thisWeekKey();
    delete weekState[wk];
    save(); render();
}
</script>
</body>
</html>
