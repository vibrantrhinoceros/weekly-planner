<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planner</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');

        * { margin:0; padding:0; box-sizing:border-box; }

        :root {
            --meeting:#667eea; --task:#48bb78; --admin:#f6ad55;
            --bg:#000; --card:#0a0a0a; --card-hover:#111;
            --border:#222; --text:#fff; --muted:#888; --danger:#ff4444;
        }

        body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* ‚îÄ‚îÄ‚îÄ WIZARD OVERLAY ‚îÄ‚îÄ‚îÄ */
        .overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.85);
            z-index:100; display:flex; align-items:center; justify-content:center;
            backdrop-filter:blur(4px);
        }
        .panel {
            background:#111; border:1px solid var(--border); border-radius:16px;
            width:520px; max-width:92vw; overflow:hidden;
        }
        .progress-bar { height:3px; background:var(--border); }
        .progress-fill { height:100%; background:var(--task); transition:width .4s cubic-bezier(.4,0,.2,1); }

        .panel-body { padding:48px 40px 40px; }

        .step { display:none; animation:fadeUp .3s ease; }
        .step.active { display:block; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        .step-emoji { font-size:36px; margin-bottom:18px; display:block; }
        .step h2 { font-size:22px; font-weight:700; margin-bottom:8px; letter-spacing:-.3px; }
        .step > p { color:var(--muted); font-size:14px; line-height:1.6; margin-bottom:28px; }

        /* input rows used in wizard + settings */
        .irow {
            display:flex; align-items:center; gap:14px;
            background:var(--card); border:1px solid var(--border);
            border-radius:10px; padding:16px 18px; margin-bottom:10px;
            transition:border-color .2s;
        }
        .irow:focus-within { border-color:#444; }
        .irow .icon { font-size:20px; flex-shrink:0; width:28px; text-align:center; }
        .irow .lbl { flex:1; font-size:14px; font-weight:500; }
        .irow .lbl small { display:block; font-size:12px; color:var(--muted); font-weight:400; margin-top:2px; }
        .irow input, .irow select {
            width:88px; padding:9px 10px; background:#1a1a1a;
            border:1px solid var(--border); border-radius:6px;
            color:#fff; font-family:'DM Mono',monospace;
            font-size:15px; font-weight:500; text-align:center;
        }
        .irow input:focus, .irow select:focus { outline:none; border-color:#555; }
        .irow .unit { font-size:13px; color:var(--muted); white-space:nowrap; }

        /* days toggle grid */
        .days-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:7px; }
        .day-tog {
            background:var(--card); border:1px solid var(--border);
            border-radius:8px; padding:13px 0; text-align:center; cursor:pointer; transition:all .2s;
        }
        .day-tog .dlbl { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
        .day-tog.on { border-color:var(--task); background:rgba(72,187,120,.08); }
        .day-tog.on .dlbl { color:var(--task); }

        /* calculated result box */
        .calc-box {
            background:rgba(72,187,120,.08); border:1px solid rgba(72,187,120,.25);
            border-radius:10px; padding:16px 18px; margin-top:18px;
            display:flex; align-items:center; gap:14px;
        }
        .calc-box .big { font-family:'DM Mono',monospace; font-size:26px; font-weight:700; color:var(--task); }
        .calc-box .desc { font-size:13px; color:var(--muted); }
        .calc-box .desc strong { color:var(--text); display:block; font-size:14px; margin-bottom:1px; }

        /* nav row */
        .nav-row { display:flex; justify-content:space-between; align-items:center; margin-top:32px; }
        .nav-row .indicator { font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.8px; }
        .nav-btns { display:flex; gap:10px; }

        .btn-ghost {
            background:none; border:1px solid var(--border); color:var(--muted);
            padding:10px 22px; border-radius:6px; font-size:13px; font-weight:600;
            cursor:pointer; font-family:inherit; transition:all .2s;
        }
        .btn-ghost:hover { border-color:#444; color:var(--text); }

        .btn-solid {
            background:var(--text); color:#000; border:none;
            padding:10px 28px; border-radius:6px; font-size:13px; font-weight:700;
            cursor:pointer; font-family:inherit; text-transform:uppercase;
            letter-spacing:.8px; transition:all .2s;
        }
        .btn-solid:hover { background:#e5e5e5; transform:translateY(-1px); }

        /* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
        .settings-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:26px 32px 18px; border-bottom:1px solid var(--border);
        }
        .settings-header h2 { font-size:20px; font-weight:700; }
        .close-btn {
            background:none; border:none; color:var(--muted); font-size:22px;
            cursor:pointer; padding:4px 8px; border-radius:6px; transition:all .2s;
        }
        .close-btn:hover { color:var(--text); background:var(--border); }
        .settings-body { padding:24px 32px 32px; }
        .settings-label {
            font-size:11px; font-weight:700; color:var(--muted);
            text-transform:uppercase; letter-spacing:.8px;
            margin-bottom:10px; margin-top:22px;
        }
        .settings-label:first-child { margin-top:0; }

        /* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
        .app { display:none; }
        .app.on { display:block; }

        .header {
            background:var(--bg); padding:28px 36px;
            border-bottom:1px solid var(--border);
            display:flex; justify-content:space-between; align-items:center;
        }
        .header h1 { font-size:30px; font-weight:700; letter-spacing:-.8px; }
        .hdr-btns { display:flex; gap:10px; }
        .btn-hdr {
            background:var(--card); border:1px solid var(--border); color:var(--muted);
            padding:9px 16px; border-radius:6px; font-size:13px; font-weight:600;
            cursor:pointer; font-family:inherit; display:flex; align-items:center; gap:7px;
            transition:all .2s;
        }
        .btn-hdr:hover { border-color:#444; color:var(--text); }
        .btn-hdr.danger:hover { border-color:var(--danger); color:var(--danger); }

        .layout { display:grid; grid-template-columns:380px 1fr; min-height:calc(100vh - 74px); }

        /* sidebar */
        .sidebar { border-right:1px solid var(--border); padding:32px 28px; overflow-y:auto; }

        .sec-title {
            font-size:12px; font-weight:700; color:var(--muted);
            text-transform:uppercase; letter-spacing:1px;
            margin-bottom:14px; display:flex; align-items:center; gap:9px;
        }
        .sec-title svg { opacity:.7; }

        .ig { margin-bottom:12px; }
        .ig label { display:block; font-size:11px; font-weight:600; color:var(--muted); margin-bottom:5px; text-transform:uppercase; letter-spacing:.5px; }
        .ig input, .ig select {
            width:100%; padding:11px 13px; border:1px solid var(--border);
            border-radius:6px; font-size:14px; font-family:inherit;
            background:var(--card); color:var(--text); transition:border-color .2s;
        }
        .ig input:focus, .ig select:focus { outline:none; border-color:#444; }

        .row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

        .add-btn {
            width:100%; padding:12px; border:none; border-radius:6px;
            font-size:12px; font-weight:700; cursor:pointer; font-family:inherit;
            text-transform:uppercase; letter-spacing:.8px;
            background:var(--text); color:#000; transition:all .2s;
        }
        .add-btn:hover { background:#e5e5e5; transform:translateY(-1px); }

        .divider { height:1px; background:var(--border); margin:24px 0; }

        /* chart */
        .chart-box {
            background:var(--card); border:1px solid var(--border);
            border-radius:10px; padding:20px; margin-bottom:24px;
        }
        .chart-box-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; margin-bottom:14px; }
        .chart-wrap { display:flex; align-items:center; justify-content:center; }
        .chart-legend { margin-top:16px; }
        .leg-row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; font-size:13px; }
        .leg-left { display:flex; align-items:center; gap:9px; }
        .leg-dot { width:11px; height:11px; border-radius:3px; }
        .leg-name { color:var(--muted); }
        .leg-val { font-weight:700; font-family:'DM Mono',monospace; font-size:12px; }

        /* stats */
        .stats-box { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:18px 20px; }
        .st-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
        .st-label { color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
        .st-val { font-weight:700; font-family:'DM Mono',monospace; font-size:14px; }
        .st-div { height:1px; background:var(--border); margin:7px 0; }
        .alert { border-radius:6px; padding:11px 13px; margin-top:12px; font-size:12px; font-weight:600; }
        .alert-warn { background:#1a0e00; border:1px solid var(--admin); color:var(--admin); }
        .alert-ok   { background:#0a1a0a; border:1px solid var(--task);  color:var(--task); }

        /* main */
        .main-area { padding:32px 28px; overflow-y:auto; }
        .week-grid {
            display:grid; gap:14px; margin-bottom:36px;
        }
        .day-col {
            background:var(--card); border:1px solid var(--border);
            border-radius:10px; padding:18px; min-height:380px;
            transition:border-color .2s, background .2s;
        }
        .day-col.drag-over { border-color:#555; background:var(--card-hover); }
        .day-col-hdr { font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; padding-bottom:10px; border-bottom:2px solid var(--text); margin-bottom:12px; }

        .time-wrap { background:#000; border:1px solid var(--border); border-radius:6px; padding:10px 12px; margin-bottom:16px; }
        .time-top { display:flex; justify-content:space-between; font-size:12px; margin-bottom:6px; }
        .time-used { font-weight:600; }
        .time-free { font-weight:700; }
        .time-free.ok  { color:var(--text); }
        .time-free.warn{ color:var(--admin); }
        .time-free.over{ color:var(--danger); }
        .tbar { height:3px; background:var(--border); border-radius:2px; overflow:hidden; }
        .tbar-fill { height:100%; background:var(--text); transition:width .3s,background .3s; }
        .tbar-fill.warn{ background:var(--admin); }
        .tbar-fill.over{ background:var(--danger); }

        /* items */
        .item {
            background:var(--card-hover); border:1px solid var(--border);
            border-left:3px solid var(--meeting); border-radius:6px;
            padding:11px 13px; margin-bottom:9px; cursor:grab;
            transition:background .15s, transform .15s;
        }
        .item:hover { background:#1e1e1e; transform:translateX(2px); }
        .item:active { cursor:grabbing; }
        .item.dragging { opacity:.35; }
        .item.task  { border-left-color:var(--task); }
        .item.admin { border-left-color:var(--admin); }
        .item.done  { opacity:.4; }
        .item.done .item-name { text-decoration:line-through; }

        .item-top { display:flex; align-items:flex-start; gap:9px; }
        .item-cb { margin-top:2px; width:16px; height:16px; cursor:pointer; flex-shrink:0; }
        .item-inner { flex:1; min-width:0; }
        .item-name { font-size:14px; font-weight:600; margin-bottom:2px; }
        .item-meta { font-size:11px; color:var(--muted); }
        .item-rm {
            background:none; border:none; color:var(--muted); cursor:pointer;
            font-size:10px; font-weight:700; text-transform:uppercase;
            letter-spacing:.5px; padding:3px 0 0 24px; font-family:inherit; transition:color .2s;
        }
        .item-rm:hover { color:var(--danger); }

        /* summary */
        .summary-box { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:28px; }
        .summary-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .summary-top h3 { font-size:18px; font-weight:700; letter-spacing:-.3px; }
        .copy-btn {
            background:var(--text); color:#000; border:none; padding:9px 18px;
            border-radius:6px; font-size:11px; font-weight:700; cursor:pointer;
            font-family:inherit; text-transform:uppercase; letter-spacing:.8px; transition:all .2s;
        }
        .copy-btn:hover { background:#e5e5e5; transform:translateY(-1px); }
        .summary-out {
            background:#000; border:1px solid var(--border); border-radius:6px;
            padding:22px; font-family:'DM Mono',monospace; font-size:13px;
            line-height:1.9; color:var(--text); white-space:pre-wrap; min-height:110px;
        }
        .summary-ph { color:#555; font-style:italic; font-family:'DM Sans',sans-serif; }

        .hidden { display:none !important; }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ WIZARD ‚îÄ‚îÄ -->
<div class="overlay" id="wizardOverlay">
  <div class="panel">
    <div class="progress-bar"><div class="progress-fill" id="wProg" style="width:25%"></div></div>
    <div class="panel-body">

      <div class="step active" id="s1">
        <span class="step-emoji">üëã</span>
        <h2>Welcome to Weekly Planner</h2>
        <p>Let's set up your planner in about 30 seconds. A few quick questions about how you work ‚Äî and we'll calculate your real available hours.</p>
        <div class="nav-row"><span class="indicator">1 of 4</span><button class="btn-solid" onclick="goStep(2)">Let's Go</button></div>
      </div>

      <div class="step" id="s2">
        <span class="step-emoji">üïò</span>
        <h2>When do you work?</h2>
        <p>Set your typical start and end times. We'll subtract breaks in the next step.</p>
        <div class="irow"><div class="icon">üåÖ</div><div class="lbl">Day starts at<small>Usual start time</small></div><input type="time" id="wStart" value="09:00"></div>
        <div class="irow"><div class="icon">üåÜ</div><div class="lbl">Day ends at<small>Usual end time</small></div><input type="time" id="wEnd" value="17:00"></div>
        <div class="nav-row"><span class="indicator">2 of 4</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(1)">Back</button><button class="btn-solid" onclick="goStep(3)">Next</button></div></div>
      </div>

      <div class="step" id="s3">
        <span class="step-emoji">‚òï</span>
        <h2>How do you take breaks?</h2>
        <p>Be real here ‚Äî a planner only works if the math is honest.</p>
        <div class="irow"><div class="icon">üçΩÔ∏è</div><div class="lbl">Lunch break<small>How long, usually?</small></div><input type="number" id="wLunch" value="30" min="0" max="120" step="5"><span class="unit">min</span></div>
        <div class="irow"><div class="icon">üõãÔ∏è</div><div class="lbl">Short breaks per day<small>Coffee, walk, stretch‚Ä¶</small></div><input type="number" id="wBreakCt" value="2" min="0" max="10" step="1"><span class="unit">breaks</span></div>
        <div class="irow"><div class="icon">‚è±Ô∏è</div><div class="lbl">Each break is<small>Average length</small></div><input type="number" id="wBreakLen" value="15" min="5" max="60" step="5"><span class="unit">min</span></div>
        <div class="nav-row"><span class="indicator">3 of 4</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(2)">Back</button><button class="btn-solid" onclick="goStep(4)">Next</button></div></div>
      </div>

      <div class="step" id="s4">
        <span class="step-emoji">üìÖ</span>
        <h2>Which days do you work?</h2>
        <p>Tap to toggle the days you plan around.</p>
        <div class="days-grid" id="wDaysGrid"></div>
        <div class="calc-box"><div class="big" id="wCalcNum">32.5h</div><div class="desc"><strong>Available this week</strong>After lunch &amp; breaks</div></div>
        <div class="nav-row"><span class="indicator">4 of 4</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(3)">Back</button><button class="btn-solid" onclick="wizardDone()">Start Planning</button></div></div>
      </div>

    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ -->
<div class="overlay hidden" id="settingsOverlay">
  <div class="panel" style="max-height:88vh;overflow-y:auto;">
    <div class="settings-header"><h2>Settings</h2><button class="close-btn" onclick="closeSettings()">‚úï</button></div>
    <div class="settings-body">
      <div class="settings-label">Work Hours</div>
      <div class="irow"><div class="icon">üåÖ</div><div class="lbl">Day starts at</div><input type="time" id="sStart"></div>
      <div class="irow"><div class="icon">üåÜ</div><div class="lbl">Day ends at</div><input type="time" id="sEnd"></div>
      <div class="settings-label">Breaks</div>
      <div class="irow"><div class="icon">üçΩÔ∏è</div><div class="lbl">Lunch break</div><input type="number" id="sLunch" min="0" max="120" step="5"><span class="unit">min</span></div>
      <div class="irow"><div class="icon">üõãÔ∏è</div><div class="lbl">Short breaks per day</div><input type="number" id="sBreakCt" min="0" max="10" step="1"><span class="unit">breaks</span></div>
      <div class="irow"><div class="icon">‚è±Ô∏è</div><div class="lbl">Each break is</div><input type="number" id="sBreakLen" min="5" max="60" step="5"><span class="unit">min</span></div>
      <div class="settings-label">Work Days</div>
      <div class="days-grid" id="sDaysGrid"></div>
      <div class="calc-box"><div class="big" id="sCalcNum">32.5h</div><div class="desc"><strong>Available this week</strong>After lunch &amp; breaks</div></div>
      <button class="btn-solid" style="width:100%;margin-top:24px;" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ APP ‚îÄ‚îÄ -->
<div class="app" id="app">
  <div class="header">
    <h1>Weekly Planner</h1>
    <div class="hdr-btns">
      <button class="btn-hdr" onclick="openSettings()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Settings
      </button>
      <button class="btn-hdr danger" onclick="resetWeek()">Reset Week</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="chart-box">
        <div class="chart-box-title">Time Breakdown</div>
        <div class="chart-wrap"><canvas id="pieChart" width="170" height="170"></canvas></div>
        <div class="chart-legend" id="chartLeg"></div>
      </div>

      <!-- Meeting -->
      <div class="sec-title"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Meeting</div>
      <div class="ig"><label>Name</label><input type="text" id="mName" placeholder="Team standup"></div>
      <div class="row2">
        <div class="ig"><label>Day</label><select id="mDay"></select></div>
        <div class="ig"><label>Hours</label><input type="number" id="mDur" value="0.5" step="0.5" min="0.5"></div>
      </div>
      <button class="add-btn" onclick="addItem('meetings')">Add Meeting</button>
      <div class="divider"></div>

      <!-- Task -->
      <div class="sec-title"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 19l7 2-7-18-7 18 7-2zm0 0v-8"/></svg> Task</div>
      <div class="ig"><label>Name</label><input type="text" id="tName" placeholder="Write proposal"></div>
      <div class="row2">
        <div class="ig"><label>Day</label><select id="tDay"></select></div>
        <div class="ig"><label>Hours</label><input type="number" id="tDur" value="0.5" step="0.5" min="0.5"></div>
      </div>
      <button class="add-btn" onclick="addItem('tasks')">Add Task</button>
      <div class="divider"></div>

      <!-- Admin -->
      <div class="sec-title"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg> Admin</div>
      <div class="ig"><label>Description</label><input type="text" id="aName" placeholder="Email, scheduling‚Ä¶"></div>
      <div class="row2">
        <div class="ig"><label>Day</label><select id="aDay"></select></div>
        <div class="ig"><label>Hours</label><input type="number" id="aDur" value="0.5" step="0.5" min="0.5"></div>
      </div>
      <button class="add-btn" onclick="addItem('admin')">Add Admin</button>
      <div class="divider"></div>

      <div class="stats-box" id="statsBox"></div>
    </div>

    <div class="main-area">
      <div class="week-grid" id="weekGrid"></div>
      <div class="summary-box">
        <div class="summary-top"><h3>Weekly Summary</h3><button class="copy-btn" onclick="copySummary()">Copy</button></div>
        <div class="summary-out" id="summaryOut"><span class="summary-ph">Check off completed items to build your weekly summary‚Ä¶</span></div>
      </div>
    </div>
  </div>
</div>

<script>
const ALL_DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
let cfg = { start:'09:00', end:'17:00', lunch:30, breakCt:2, breakLen:15, days:['Monday','Tuesday','Wednesday','Thursday','Friday'] };
let data = {};
let drag = null;

/* ‚îÄ‚îÄ helpers ‚îÄ‚îÄ */
function dayHours() {
    const [sh,sm] = cfg.start.split(':').map(Number);
    const [eh,em] = cfg.end.split(':').map(Number);
    return Math.max(0, ((eh*60+em)-(sh*60+sm)) - cfg.lunch - cfg.breakCt*cfg.breakLen) / 60;
}
function weekHours() { return dayHours() * cfg.days.length; }
function ensureData() { cfg.days.forEach(d => { if(!data[d]) data[d]={meetings:[],tasks:[],admin:[]}; }); }
function save() { localStorage.setItem('wp_cfg', JSON.stringify(cfg)); localStorage.setItem('wp_data', JSON.stringify(data)); }

/* ‚îÄ‚îÄ boot ‚îÄ‚îÄ */
(function boot() {
    const c = localStorage.getItem('wp_cfg');
    if (c) {
        cfg  = JSON.parse(c);
        data = JSON.parse(localStorage.getItem('wp_data') || '{}');
        ensureData();
        document.getElementById('wizardOverlay').classList.add('hidden');
        showApp();
    } else {
        renderDaysToggle('wDaysGrid');
        updCalc('wCalcNum');
    }
})();

/* ‚îÄ‚îÄ days toggle ‚îÄ‚îÄ */
function renderDaysToggle(id) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    ALL_DAYS.forEach(d => {
        const on = cfg.days.includes(d);
        const t = document.createElement('div');
        t.className = 'day-tog' + (on ? ' on' : '');
        t.innerHTML = `<div class="dlbl">${d.slice(0,3)}</div>`;
        t.onclick = () => {
            if (cfg.days.includes(d)) { if (cfg.days.length > 1) cfg.days = cfg.days.filter(x=>x!==d); }
            else { cfg.days.push(d); cfg.days.sort((a,b)=>ALL_DAYS.indexOf(a)-ALL_DAYS.indexOf(b)); }
            renderDaysToggle(id);
            updCalc(id === 'wDaysGrid' ? 'wCalcNum' : 'sCalcNum');
        };
        el.appendChild(t);
    });
}
function updCalc(id) { document.getElementById(id).textContent = weekHours().toFixed(1) + 'h'; }

/* ‚îÄ‚îÄ wizard ‚îÄ‚îÄ */
function goStep(n) {
    // pull values when leaving a step
    if (n >= 3) { cfg.start = document.getElementById('wStart').value; cfg.end = document.getElementById('wEnd').value; }
    if (n >= 4) { cfg.lunch = +document.getElementById('wLunch').value||30; cfg.breakCt = +document.getElementById('wBreakCt').value||0; cfg.breakLen = +document.getElementById('wBreakLen').value||15; updCalc('wCalcNum'); }

    document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');
    document.getElementById('wProg').style.width = (n*25)+'%';
}

function wizardDone() { ensureData(); save(); document.getElementById('wizardOverlay').classList.add('hidden'); showApp(); }

/* ‚îÄ‚îÄ settings ‚îÄ‚îÄ */
function openSettings() {
    document.getElementById('sStart').value    = cfg.start;
    document.getElementById('sEnd').value      = cfg.end;
    document.getElementById('sLunch').value    = cfg.lunch;
    document.getElementById('sBreakCt').value  = cfg.breakCt;
    document.getElementById('sBreakLen').value = cfg.breakLen;
    renderDaysToggle('sDaysGrid');
    updCalc('sCalcNum');
    document.getElementById('settingsOverlay').classList.remove('hidden');
}
function closeSettings() { document.getElementById('settingsOverlay').classList.add('hidden'); }
function saveSettings() {
    cfg.start   = document.getElementById('sStart').value;
    cfg.end     = document.getElementById('sEnd').value;
    cfg.lunch   = +document.getElementById('sLunch').value||30;
    cfg.breakCt = +document.getElementById('sBreakCt').value||0;
    cfg.breakLen= +document.getElementById('sBreakLen').value||15;
    ensureData(); save(); closeSettings(); render();
}

/* ‚îÄ‚îÄ add / remove ‚îÄ‚îÄ */
const FLDS = {
    meetings:{n:'mName',d:'mDay',dur:'mDur'},
    tasks:   {n:'tName',d:'tDay',dur:'tDur'},
    admin:   {n:'aName',d:'aDay',dur:'aDur'}
};
function addItem(type) {
    const f=FLDS[type];
    const name=document.getElementById(f.n).value.trim();
    const day =document.getElementById(f.d).value;
    const dur =parseFloat(document.getElementById(f.dur).value);
    if (!name||!dur) return;
    data[day][type].push({name,duration:dur,completed:false});
    document.getElementById(f.n).value='';
    document.getElementById(f.dur).value='0.5';
    save(); render();
}
function removeItem(day,type,i) { data[day][type].splice(i,1); save(); render(); }
function toggleDone(day,type,i) { data[day][type][i].completed=!data[day][type][i].completed; save(); render(); }

/* ‚îÄ‚îÄ drag ‚îÄ‚îÄ */
function dStart(e,day,type,i) { drag={day,type,i}; e.currentTarget.classList.add('dragging'); }
function dEnd(e) { e.currentTarget.classList.remove('dragging'); document.querySelectorAll('.day-col').forEach(c=>c.classList.remove('drag-over')); }
function dOver(e) { e.preventDefault(); }
function dEnter(e) { e.currentTarget.classList.add('drag-over'); }
function dLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function dDrop(e,target) {
    e.preventDefault(); e.currentTarget.classList.remove('drag-over');
    if (!drag||drag.day===target) return;
    const item=data[drag.day][drag.type].splice(drag.i,1)[0];
    data[target][drag.type].push(item);
    drag=null; save(); render();
}

/* ‚îÄ‚îÄ populate selects ‚îÄ‚îÄ */
function fillSelects() {
    ['mDay','tDay','aDay'].forEach(id => {
        const s=document.getElementById(id);
        s.innerHTML='';
        cfg.days.forEach(d => s.innerHTML+=`<option value="${d}">${d}</option>`);
    });
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function showApp() { document.getElementById('app').classList.add('on'); fillSelects(); render(); }

function render() { renderGrid(); renderPie(); renderStats(); renderSummary(); }

function renderGrid() {
    const g=document.getElementById('weekGrid');
    g.style.gridTemplateColumns = `repeat(${cfg.days.length},1fr)`;
    g.innerHTML='';
    const dh=dayHours();

    cfg.days.forEach(day => {
        const M=data[day]?.meetings||[];
        const T=data[day]?.tasks||[];
        const A=data[day]?.admin||[];
        const used=[...M,...T,...A].reduce((s,i)=>s+i.duration,0);
        const free=dh-used;
        const pct=Math.min((used/dh)*100,100);
        const barCls=used>dh?'over':pct>80?'warn':'';
        const freeCls=free<0?'over':free<=dh*.2?'warn':'ok';

        const col=document.createElement('div');
        col.className='day-col';
        col.ondragover=dOver; col.ondragenter=dEnter; col.ondragleave=dLeave;
        col.ondrop=e=>dDrop(e,day);

        let items='';
        const row=(arr,type,cls)=>arr.forEach((it,i)=>{
            const label = type==='meetings'?'Meeting':type==='tasks'?'Task':'Admin';
            items+=`<div class="item ${cls} ${it.completed?'done':''}" draggable ondragstart="dStart(event,'${day}','${type}',${i})" ondragend="dEnd(event)">
                <div class="item-top">
                    <input class="item-cb" type="checkbox" ${it.completed?'checked':''} onchange="toggleDone('${day}','${type}',${i})">
                    <div class="item-inner"><div class="item-name">${it.name}</div><div class="item-meta">${it.duration}h ¬∑ ${label}</div></div>
                </div>
                <button class="item-rm" onclick="removeItem('${day}','${type}',${i})">Remove</button>
            </div>`;
        });
        row(M,'meetings','');
        row(T,'tasks','task');
        row(A,'admin','admin');

        col.innerHTML=`
            <div class="day-col-hdr">${day}</div>
            <div class="time-wrap">
                <div class="time-top"><span class="time-used">${used.toFixed(1)}h used</span><span class="time-free ${freeCls}">${free>=0?free.toFixed(1)+'h free':Math.abs(free).toFixed(1)+'h over'}</span></div>
                <div class="tbar"><div class="tbar-fill ${barCls}" style="width:${pct}%"></div></div>
            </div>${items}`;
        g.appendChild(col);
    });
}

function renderPie() {
    const c=document.getElementById('pieChart'), ctx=c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    let M=0,T=0,A=0;
    cfg.days.forEach(d=>{
        (data[d]?.meetings||[]).forEach(i=>M+=i.duration);
        (data[d]?.tasks||[]).forEach(i=>T+=i.duration);
        (data[d]?.admin||[]).forEach(i=>A+=i.duration);
    });
    const tot=M+T+A;
    const cx=c.width/2, cy=c.height/2, r=65;

    if(!tot) {
        ctx.strokeStyle='#222'; ctx.lineWidth=14;
        ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
        document.getElementById('chartLeg').innerHTML='<div style="color:#555;text-align:center;font-size:12px;padding-top:6px;">No time logged yet</div>';
        return;
    }

    const slices=[
        {label:'Meetings',val:M,color:'#667eea'},
        {label:'Tasks',val:T,color:'#48bb78'},
        {label:'Admin',val:A,color:'#f6ad55'}
    ].filter(s=>s.val>0);

    let ang=-Math.PI/2;
    slices.forEach(s=>{
        const sw=(s.val/tot)*Math.PI*2;
        ctx.fillStyle=s.color;
        ctx.beginPath(); ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,ang,ang+sw); ctx.closePath(); ctx.fill();
        ang+=sw;
    });
    // hole
    ctx.fillStyle='#0a0a0a';
    ctx.beginPath(); ctx.arc(cx,cy,r-20,0,Math.PI*2); ctx.fill();
    // center label
    ctx.fillStyle='#fff';
    ctx.font='700 15px "DM Mono",monospace';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(tot.toFixed(1)+'h',cx,cy);

    document.getElementById('chartLeg').innerHTML=slices.map(s=>
        `<div class="leg-row"><div class="leg-left"><div class="leg-dot" style="background:${s.color}"></div><span class="leg-name">${s.label}</span></div><span class="leg-val">${s.val.toFixed(1)}h</span></div>`
    ).join('');
}

function renderStats() {
    let M=0,T=0,A=0,over=0;
    const dh=dayHours();
    cfg.days.forEach(d=>{
        let u=0;
        (data[d]?.meetings||[]).forEach(i=>{M+=i.duration;u+=i.duration;});
        (data[d]?.tasks||[]).forEach(i=>{T+=i.duration;u+=i.duration;});
        (data[d]?.admin||[]).forEach(i=>{A+=i.duration;u+=i.duration;});
        if(u>dh) over++;
    });
    const tot=M+T+A;
    document.getElementById('statsBox').innerHTML=`
        <div class="st-row"><span class="st-label">Meetings</span><span class="st-val">${M.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">Tasks</span><span class="st-val">${T.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">Admin</span><span class="st-val">${A.toFixed(1)}h</span></div>
        <div class="st-div"></div>
        <div class="st-row"><span class="st-label">Week Total</span><span class="st-val">${tot.toFixed(1)}h / ${weekHours().toFixed(1)}h</span></div>
        ${over>0?`<div class="alert alert-warn">‚ö†Ô∏è ${over} day(s) overbooked</div>`:tot>0?`<div class="alert alert-ok">‚úì Week balanced</div>`:''}`;
}

function renderSummary() {
    let lines=[], any=false, cM=0,cT=0,cA=0;
    cfg.days.forEach(day=>{
        const dl=[];
        (data[day]?.meetings||[]).filter(i=>i.completed).forEach(i=>{dl.push(`  ‚Ä¢ ${i.name} (${i.duration}h)`);cM+=i.duration;any=true;});
        (data[day]?.tasks||[]).filter(i=>i.completed).forEach(i=>{dl.push(`  ‚Ä¢ ${i.name} (${i.duration}h)`);cT+=i.duration;any=true;});
        (data[day]?.admin||[]).filter(i=>i.completed).forEach(i=>{dl.push(`  ‚Ä¢ ${i.name} (${i.duration}h)`);cA+=i.duration;any=true;});
        if(dl.length){ lines.push(day.toUpperCase()); lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'); lines.push(...dl); lines.push(''); }
    });
    if(!any){ document.getElementById('summaryOut').innerHTML='<span class="summary-ph">Check off completed items to build your weekly summary‚Ä¶</span>'; return; }
    const cTot=cM+cT+cA;
    lines.push('HOURS BREAKDOWN');
    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    lines.push(`  Meetings:     ${cM.toFixed(1)}h`);
    lines.push(`  Tasks:        ${cT.toFixed(1)}h`);
    lines.push(`  Admin:        ${cA.toFixed(1)}h`);
    lines.push(`  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
    lines.push(`  Total:        ${cTot.toFixed(1)}h`);
    document.getElementById('summaryOut').textContent=lines.join('\n');
}

function copySummary() {
    const el=document.getElementById('summaryOut');
    if(el.querySelector('.summary-ph')) return;
    navigator.clipboard.writeText(el.textContent).then(()=>{
        const b=document.querySelector('.copy-btn');
        b.textContent='Copied!';
        setTimeout(()=>b.textContent='Copy',2000);
    });
}

function resetWeek() {
    if(!confirm('Clear everything for this week?')) return;
    data={}; ensureData(); save(); render();
}
</script>
</body>
</html>