<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Navigator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }

:root {
    /* Category colors - muted, elegant */
    --meeting:#7c8db0; --meeting-light:#a3b1cf;
    --task:#5a9a8a;    --task-light:#7ab8a8;
    --admin:#a08060;   --admin-light:#c4a882;
    --pto:#8a8a8a;     --pto-light:#aaa;
    
    /* Priority accent - teal */
    --priority:#0d9488; --priority-glow:rgba(13,148,136,.2);
    
    /* Light elegant palette */
    --bg:#f6f7f9; --card:#ffffff; --card-hover:#fafbfc;
    --border:#e2e5eb; --border-light:#eef0f4;
    --text:#2d3748; --text-secondary:#4a5568; --muted:#718096;
    --danger:#e53e3e;
    
    /* Teal accent system */
    --teal-dark:#115e59; --teal-mid:#0d9488; --teal-light:#14b8a6; --teal-pale:#5eead4;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0,0,0,.04), 0 1px 3px rgba(0,0,0,.06);
    --shadow-md: 0 2px 4px rgba(0,0,0,.04), 0 4px 12px rgba(0,0,0,.06);
    --shadow-lg: 0 4px 8px rgba(0,0,0,.04), 0 8px 24px rgba(0,0,0,.08);
    
    /* Gradients */
    --grad-meeting: linear-gradient(135deg, var(--meeting), var(--meeting-light));
    --grad-task:    linear-gradient(135deg, var(--task),    var(--task-light));
    --grad-admin:   linear-gradient(135deg, var(--admin),   var(--admin-light));
    --grad-pto:     linear-gradient(135deg, var(--pto),     var(--pto-light));
    --grad-progress:linear-gradient(90deg, var(--teal-dark) 0%, var(--teal-mid) 50%, var(--teal-light) 100%);
}

body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* ‚îÄ‚îÄ‚îÄ OVERLAYS ‚îÄ‚îÄ‚îÄ */
.overlay { position:fixed; inset:0; background:rgba(45,55,72,0.4); z-index:100; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.panel { background:var(--card); border:1px solid var(--border); border-radius:16px; width:520px; max-width:92vw; overflow:hidden; box-shadow:var(--shadow-lg); }
.progress-bar { height:3px; background:var(--border-light); }
.progress-fill { height:100%; background-image:var(--grad-task); transition:width .4s cubic-bezier(.4,0,.2,1); }
.panel-body { padding:48px 40px 40px; }
.step { display:none; animation:fadeUp .3s ease; }
.step.active { display:block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.step-emoji { font-size:36px; margin-bottom:18px; display:block; }
.step h2 { font-size:22px; font-weight:700; margin-bottom:8px; letter-spacing:-.3px; color:var(--text); }
.step > p { color:var(--muted); font-size:14px; line-height:1.6; margin-bottom:28px; }

/* input rows */
.irow { display:flex; align-items:center; gap:14px; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:16px 18px; margin-bottom:10px; transition:border-color .2s, box-shadow .2s; }
.irow:focus-within { border-color:var(--teal-mid); box-shadow:0 0 0 3px rgba(13,148,136,.1); }
.irow .icon { font-size:20px; flex-shrink:0; width:28px; text-align:center; }
.irow .lbl { flex:1; font-size:14px; font-weight:500; color:var(--text); }
.irow .lbl small { display:block; font-size:12px; color:var(--muted); font-weight:400; margin-top:2px; }
.irow input, .irow select { width:88px; padding:9px 10px; background:var(--card); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:'JetBrains Mono',monospace; font-size:15px; font-weight:500; text-align:center; }
.irow input:focus, .irow select:focus { outline:none; border-color:var(--teal-mid); }
.irow .unit { font-size:13px; color:var(--muted); white-space:nowrap; }

/* days toggle */
.days-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:7px; }
.day-tog { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:13px 0; text-align:center; cursor:pointer; transition:all .2s; box-shadow:var(--shadow-sm); }
.day-tog:hover { border-color:var(--teal-light); }
.day-tog .dlbl { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
.day-tog.on { border-color:var(--teal-mid); background:rgba(13,148,136,.06); box-shadow:0 0 0 3px rgba(13,148,136,.08); }
.day-tog.on .dlbl { color:var(--teal-dark); font-weight:700; }

/* calc box */
.calc-box { background:rgba(13,148,136,.06); border:1px solid rgba(13,148,136,.15); border-radius:10px; padding:16px 18px; margin-top:18px; display:flex; align-items:center; gap:14px; }
.calc-box .big { font-family:'JetBrains Mono',monospace; font-size:26px; font-weight:700; color:var(--teal-dark); }
.calc-box .desc { font-size:13px; color:var(--muted); }
.calc-box .desc strong { color:var(--text); display:block; font-size:14px; margin-bottom:1px; }

/* nav */
.nav-row { display:flex; justify-content:space-between; align-items:center; margin-top:32px; }
.nav-row .indicator { font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.8px; }
.nav-btns { display:flex; gap:10px; }
.btn-ghost { background:none; border:1px solid var(--border); color:var(--muted); padding:10px 22px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .2s; }
.btn-ghost:hover { border-color:var(--text-secondary); color:var(--text); }
.btn-solid { background:var(--text); color:#fff; border:none; padding:10px 28px; border-radius:6px; font-size:13px; font-weight:700; cursor:pointer; font-family:inherit; text-transform:uppercase; letter-spacing:.8px; transition:all .2s; box-shadow:var(--shadow-sm); }
.btn-solid:hover { background:var(--text-secondary); transform:translateY(-1px); box-shadow:var(--shadow-md); }

/* ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ */
.settings-header { display:flex; justify-content:space-between; align-items:center; padding:26px 32px 18px; border-bottom:1px solid var(--border); }
.settings-header h2 { font-size:20px; font-weight:700; color:var(--text); }
.close-btn { background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; transition:all .2s; }
.close-btn:hover { color:var(--text); background:var(--bg); }
.settings-body { padding:24px 32px 32px; }
.settings-label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; margin-bottom:10px; margin-top:22px; }
.settings-label:first-child { margin-top:0; }

/* flex slider */
.flex-row { display:flex; align-items:center; gap:14px; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:14px 18px; margin-top:10px; }
.flex-row .flex-icon { font-size:20px; flex-shrink:0; }
.flex-row .flex-lbl { flex:1; font-size:14px; font-weight:500; color:var(--text); }
.flex-row .flex-lbl small { display:block; font-size:12px; color:var(--muted); font-weight:400; margin-top:2px; }
.flex-row input[type=range] { width:90px; accent-color:var(--teal-mid); cursor:pointer; }
.flex-row .flex-val { font-family:'JetBrains Mono',monospace; font-size:15px; font-weight:700; color:var(--teal-dark); width:36px; text-align:center; }

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
.app { display:none; }
.app.on { display:block; }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header { background:var(--card); padding:22px 36px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; box-shadow:var(--shadow-sm); }
.header-left { display:flex; align-items:center; gap:14px; }
.header-left .compass { font-size:28px; }
.header h1 { font-size:28px; font-weight:700; letter-spacing:-.6px; color:var(--text); }
.header h1 span { color:var(--teal-mid); }
.header-sub { font-size:12px; color:var(--muted); margin-top:1px; letter-spacing:.3px; }
.hdr-btns { display:flex; gap:10px; }
.btn-hdr { background:var(--card); border:1px solid var(--border); color:var(--muted); padding:9px 16px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; display:flex; align-items:center; gap:7px; transition:all .2s; box-shadow:var(--shadow-sm); }
.btn-hdr:hover { border-color:var(--text-secondary); color:var(--text); }
.btn-hdr.danger:hover { border-color:var(--danger); color:var(--danger); }

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.layout { display:grid; grid-template-columns:340px 1fr; min-height:calc(100vh - 68px); }

/* sidebar */
.sidebar { background:var(--card); border-right:1px solid var(--border); padding:28px 24px; overflow-y:auto; box-shadow:var(--shadow-sm); }
.sec-title { font-size:12px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:14px; display:flex; align-items:center; gap:9px; }
.ig { margin-bottom:12px; }
.ig label { display:block; font-size:11px; font-weight:600; color:var(--muted); margin-bottom:5px; text-transform:uppercase; letter-spacing:.5px; }
.ig input, .ig select { width:100%; padding:11px 13px; border:1px solid var(--border); border-radius:6px; font-size:14px; font-family:inherit; background:var(--card); color:var(--text); transition:border-color .2s, box-shadow .2s; }
.ig input:focus, .ig select:focus { outline:none; border-color:var(--teal-mid); box-shadow:0 0 0 3px rgba(13,148,136,.1); }
.row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.add-btn { width:100%; padding:12px; border:none; border-radius:6px; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit; text-transform:uppercase; letter-spacing:.8px; background:var(--text); color:#fff; transition:all .2s; box-shadow:var(--shadow-sm); }
.add-btn:hover { background:var(--text-secondary); transform:translateY(-1px); box-shadow:var(--shadow-md); }
.divider { height:1px; background:var(--border); margin:22px 0; }

/* full day toggle */
.fullday-row { display:flex; align-items:center; gap:12px; padding:10px 13px; background:var(--bg); border:1px solid var(--border); border-radius:6px; margin-bottom:12px; cursor:pointer; transition:border-color .2s; }
.fullday-row:hover { border-color:var(--text-secondary); }
.fullday-row.active { border-color:var(--pto); background:rgba(138,138,138,.08); }
.toggle-track { width:36px; height:20px; background:var(--border); border-radius:10px; position:relative; transition:background .2s; flex-shrink:0; }
.toggle-track.on { background:var(--pto); }
.toggle-track .knob { width:16px; height:16px; background:#fff; border-radius:50%; position:absolute; top:2px; left:2px; transition:left .2s; box-shadow:var(--shadow-sm); }
.toggle-track.on .knob { left:18px; }
.fullday-label { font-size:13px; font-weight:500; color:var(--text); }
.fullday-label small { display:block; font-size:11px; color:var(--muted); font-weight:400; }

/* priority toggle */
.priority-row { display:flex; align-items:center; gap:10px; padding:9px 13px; background:var(--bg); border:1px solid var(--border); border-radius:6px; margin-bottom:12px; cursor:pointer; transition:all .2s; }
.priority-row:hover { border-color:var(--teal-mid); }
.priority-row.active { border-color:var(--priority); background:rgba(13,148,136,.06); }
.priority-icon { font-size:18px; }
.priority-label { font-size:13px; font-weight:600; flex:1; color:var(--text); }
.priority-label small { display:block; font-size:11px; color:var(--muted); font-weight:400; }
.priority-toggle { font-size:11px; font-weight:700; padding:4px 10px; border-radius:4px; border:1px solid var(--border); background:transparent; color:var(--muted); font-family:inherit; cursor:pointer; transition:all .15s; }
.priority-row.active .priority-toggle { border-color:var(--priority); color:var(--priority); background:rgba(13,148,136,.08); }

/* recurring chips */
.rec-chip { display:flex; align-items:center; gap:10px; background:var(--bg); border:1px solid var(--border); border-left:3px solid var(--meeting); border-radius:6px; padding:10px 12px; margin-bottom:8px; box-shadow:var(--shadow-sm); }
.rec-chip .rc-inner { flex:1; min-width:0; }
.rec-chip .rc-name { font-size:14px; font-weight:600; color:var(--text); }
.rec-chip .rc-meta { font-size:11px; color:var(--muted); margin-top:2px; }
.rec-chip .rc-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:16px; line-height:1; padding:2px; transition:color .2s; }
.rec-chip .rc-del:hover { color:var(--danger); }

/* parity */
.parity-row { display:flex; align-items:center; gap:10px; background:rgba(13,148,136,.04); border:1px solid rgba(13,148,136,.15); border-radius:6px; padding:10px 12px; margin-bottom:12px; }
.parity-row span { font-size:12px; color:var(--teal-dark); flex:1; }
.parity-btn { background:none; border:1px solid rgba(13,148,136,.25); color:var(--teal-dark); padding:5px 10px; border-radius:4px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; transition:all .2s; }
.parity-btn:hover { border-color:var(--teal-mid); background:rgba(13,148,136,.08); }

/* suggestions tray */
.suggestions-tray { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px 20px; margin-bottom:24px; box-shadow:var(--shadow-md); }
.suggestions-title { font-size:11px; font-weight:700; color:var(--teal-dark); text-transform:uppercase; letter-spacing:.8px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.suggestions-title .s-count { background:var(--grad-progress); color:#fff; font-size:10px; padding:2px 7px; border-radius:10px; font-weight:700; }
.suggestion-item { display:flex; align-items:center; gap:12px; background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:11px 13px; margin-bottom:8px; }
.suggestion-item:last-child { margin-bottom:0; }
.suggestion-item .si-inner { flex:1; min-width:0; }
.suggestion-item .si-name { font-size:14px; font-weight:600; color:var(--text); }
.suggestion-item .si-meta { font-size:11px; color:var(--muted); margin-top:2px; }
.si-btns { display:flex; gap:6px; flex-shrink:0; }
.si-btn { padding:6px 12px; border-radius:4px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; border:none; transition:all .15s; text-transform:uppercase; letter-spacing:.5px; }
.si-btn.add { background:var(--grad-progress); color:#fff; box-shadow:var(--shadow-sm); }
.si-btn.add:hover { filter:brightness(1.1); transform:translateY(-1px); }
.si-btn.skip { background:transparent; color:var(--muted); border:1px solid var(--border); }
.si-btn.skip:hover { border-color:var(--text-secondary); color:var(--text); }

/* recurring mini-form */
.wiz-rec-form { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:14px; }
.wiz-rec-form .wr-row { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
.wiz-rec-form .wr-row:last-child { margin-bottom:0; }
.wiz-rec-form input, .wiz-rec-form select { padding:9px 10px; background:var(--card); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:inherit; font-size:13px; transition:border-color .2s; min-width:0; }
.wiz-rec-form input:focus, .wiz-rec-form select:focus { outline:none; border-color:var(--teal-mid); }
.wiz-rec-form .wr-name { flex:1; min-width:0; }
.wiz-rec-form .wr-dur { width:68px; text-align:center; font-family:'JetBrains Mono',monospace; flex-shrink:0; }
.wiz-rec-form .wr-row select { flex:1; min-width:0; }
.wiz-rec-form .wr-add { width:100%; margin-top:4px; background:var(--text); color:#fff; border:none; padding:9px 14px; border-radius:6px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; text-transform:uppercase; letter-spacing:.5px; transition:all .15s; }
.wiz-rec-form .wr-add:hover { background:var(--text-secondary); transform:translateY(-1px); }
.wiz-rec-form select:disabled { opacity:.35; }

/* wizard rec pills */
.wiz-rec-pills { margin-top:12px; }
.wiz-rec-pill { display:flex; align-items:center; justify-content:space-between; background:rgba(124,141,176,.08); border:1px solid rgba(124,141,176,.2); border-radius:6px; padding:8px 11px; margin-bottom:6px; font-size:13px; }
.wiz-rec-pill .wp-left { display:flex; align-items:center; gap:8px; }
.wiz-rec-pill .wp-dot { width:8px; height:8px; background:var(--meeting); border-radius:50%; }
.wiz-rec-pill .wp-rm { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; transition:color .2s; }
.wiz-rec-pill .wp-rm:hover { color:var(--danger); }

/* chart */
.chart-box { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:20px; margin-bottom:24px; }
.chart-wrap { display:flex; align-items:center; justify-content:center; }
.chart-legend { margin-top:16px; }
.leg-row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; font-size:13px; }
.leg-left { display:flex; align-items:center; gap:9px; }
.leg-dot { width:11px; height:11px; border-radius:3px; }
.leg-name { color:var(--muted); }
.leg-val { font-weight:700; font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--text); }

/* stats */
.stats-box { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:18px 20px; }
.st-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
.st-label { color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
.st-val { font-weight:700; font-family:'JetBrains Mono',monospace; font-size:14px; color:var(--text); }
.st-div { height:1px; background:var(--border); margin:7px 0; }
.alert { border-radius:6px; padding:11px 13px; margin-top:12px; font-size:12px; font-weight:600; }
.alert-warn { background:rgba(160,128,96,.1); border:1px solid var(--admin); color:var(--admin); }
.alert-ok   { background:rgba(90,154,138,.08); border:1px solid var(--task); color:var(--task); }

/* ‚îÄ‚îÄ‚îÄ MAIN AREA ‚îÄ‚îÄ‚îÄ */
.main-area { padding:28px 32px; overflow-y:auto; }
.week-grid { display:grid; gap:16px; margin-bottom:28px; }

.day-col { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; min-height:360px; transition:border-color .2s, box-shadow .2s; box-shadow:var(--shadow-sm); }
.day-col.drag-over { border-color:var(--teal-mid); box-shadow:var(--shadow-md), 0 0 0 3px rgba(13,148,136,.1); }
.day-col-hdr { font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--text-secondary); padding:10px 12px; margin:-18px -18px 14px; background:var(--bg); border-bottom:1px solid var(--border); border-radius:12px 12px 0 0; }

/* capacity bar */
.time-wrap { background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:10px 12px; margin-bottom:16px; }
.time-top { display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px; }
.time-used { font-weight:600; color:var(--text-secondary); }
.time-free { font-weight:700; }
.time-free.ok  { color:var(--text); }
.time-free.warn{ color:var(--admin); }
.time-free.over{ color:var(--danger); }
.tbar { height:6px; background:var(--border-light); border-radius:3px; overflow:hidden; }
.tbar-fill      { height:100%; border-radius:3px; transition:width .3s; background-image:var(--grad-task); }
.tbar-fill.warn { background-image:var(--grad-admin); }
.tbar-fill.over { background-image:linear-gradient(135deg,var(--danger),#fc8181); }
.time-flex-note { font-size:10px; color:var(--muted); margin-top:5px; text-align:right; letter-spacing:.2px; }

/* PTO banner */
.pto-banner { background:rgba(138,138,138,.08); border:1px solid rgba(138,138,138,.25); border-radius:6px; padding:10px 12px; margin-bottom:10px; text-align:center; }
.pto-banner .pto-label { font-size:13px; font-weight:700; color:var(--pto); text-transform:uppercase; letter-spacing:.8px; }
.pto-banner .pto-sub { font-size:11px; color:var(--muted); margin-top:2px; }
.pto-banner .pto-rm { background:none; border:none; color:var(--muted); font-size:10px; font-weight:700; cursor:pointer; font-family:inherit; text-transform:uppercase; letter-spacing:.5px; margin-top:4px; display:block; transition:color .2s; }
.pto-banner .pto-rm:hover { color:var(--danger); }

/* ‚îÄ‚îÄ‚îÄ ITEM CARDS ‚îÄ‚îÄ‚îÄ */
.item { background:var(--card); border:1px solid var(--border); border-left:3px solid var(--meeting); border-radius:8px; padding:11px 13px; margin-bottom:9px; cursor:grab; transition:all .15s; position:relative; box-shadow:var(--shadow-sm); }
.item:hover { box-shadow:var(--shadow-md); transform:translateY(-1px); }
.item:active { cursor:grabbing; }
.item.dragging { opacity:.35; }
.item.task  { border-left-color:var(--task); }
.item.admin { border-left-color:var(--admin); }
.item.pto   { border-left-color:var(--pto); }
.item.done  { opacity:.5; }
.item.done .item-name { text-decoration:line-through; color:var(--muted); }

/* priority ‚Äî teal glow on left border */
.item.priority { border-left-color:var(--priority); box-shadow:var(--shadow-sm), inset 3px 0 8px var(--priority-glow); }

.item-top { display:flex; align-items:flex-start; gap:9px; }

/* custom checkbox */
.item-cb { -webkit-appearance:none; appearance:none; margin-top:3px; width:16px; height:16px; flex-shrink:0; border:2px solid var(--border); border-radius:4px; background:transparent; cursor:pointer; transition:background .15s, border-color .15s; position:relative; z-index:3; }
.item-cb:hover { border-color:var(--teal-mid); }
.item-cb:checked { background:var(--task); border-color:var(--task); }
.item-cb:checked::after { content:''; position:absolute; left:4px; top:1px; width:5px; height:9px; border:solid #fff; border-width:0 2px 2px 0; transform:rotate(45deg); }

.item-inner { flex:1; min-width:0; }
.item-name { font-size:14px; font-weight:600; margin-bottom:2px; color:var(--text); }
.item-meta { font-size:11px; color:var(--muted); }

/* priority badge */
.priority-badge { display:inline-flex; align-items:center; gap:3px; font-size:10px; font-weight:700; color:var(--priority); background:rgba(13,148,136,.1); padding:2px 6px; border-radius:3px; margin-left:6px; text-transform:uppercase; letter-spacing:.4px; }

/* ‚îÄ‚îÄ HOVER OVERLAY ‚îÄ‚îÄ */
.item-hover-overlay {
    position:absolute; inset:0; border-radius:7px;
    background:rgba(255,255,255,0);
    display:flex; align-items:center; justify-content:center; gap:10px;
    flex-wrap:wrap;
    opacity:0; pointer-events:none;
    transition:background .18s, opacity .18s;
    z-index:2;
    min-height:100%;
    padding:8px;
}
.item:hover .item-hover-overlay { background:rgba(255,255,255,.92); opacity:1; pointer-events:auto; }
.item.done:hover .item-hover-overlay { background:rgba(255,255,255,.95); opacity:1; pointer-events:auto; }

.hov-btn {
    color:var(--text); font-size:11px; font-weight:700; font-family:inherit;
    background:var(--bg); border:1px solid var(--border); border-radius:5px;
    padding:7px 13px; cursor:pointer; text-transform:uppercase; letter-spacing:.6px;
    transition:all .15s; display:flex; align-items:center; gap:5px; white-space:nowrap;
    box-shadow:var(--shadow-sm);
    flex-shrink:0;
}
.hov-btn:hover { border-color:var(--text-secondary); box-shadow:var(--shadow-md); }
.hov-btn.del:hover { border-color:var(--danger); color:var(--danger); background:rgba(229,62,62,.05); }
.hov-btn.priority-on { border-color:var(--priority); color:var(--priority); background:rgba(13,148,136,.06); }
.hov-btn.priority-on:hover { background:rgba(13,148,136,.12); }

/* ‚îÄ‚îÄ inline-edit ‚îÄ‚îÄ */
.item.editing { cursor:default; }
.item.editing:hover { transform:none; box-shadow:var(--shadow-sm); }
.item.editing .item-hover-overlay { display:none !important; }
.item-edit-row { display:flex; align-items:center; gap:8px; width:100%; position:relative; z-index:3; }
.item-edit-row input { background:var(--bg); border:1px solid var(--border); border-radius:5px; color:var(--text); font-family:inherit; font-size:13px; padding:5px 8px; transition:border-color .2s; }
.item-edit-row input:focus { outline:none; border-color:var(--teal-mid); }
.item-edit-row .ef-name { flex:1; min-width:0; }
.item-edit-row .ef-dur  { width:54px; text-align:center; font-family:'JetBrains Mono',monospace; }
.ef-btns { display:flex; gap:5px; flex-shrink:0; }
.ef-btns button { background:none; border:none; cursor:pointer; font-size:15px; padding:2px 5px; border-radius:4px; transition:all .15s; }
.ef-btns .ef-save   { color:var(--task); }
.ef-btns .ef-save:hover { background:rgba(90,154,138,.1); }
.ef-btns .ef-cancel { color:var(--muted); }
.ef-btns .ef-cancel:hover { background:var(--bg); color:var(--text); }

/* recurring badge */
.rec-badge { display:inline-block; font-size:9px; font-weight:700; background:rgba(124,141,176,.15); color:var(--meeting); padding:1px 5px; border-radius:3px; margin-left:5px; text-transform:uppercase; letter-spacing:.4px; }

/* ‚îÄ‚îÄ‚îÄ HORIZONTAL PROGRESS BAR ‚îÄ‚îÄ‚îÄ */
.progress-section {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px 24px;
    margin-bottom:28px;
    box-shadow:var(--shadow-sm);
}
.progress-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
}
.progress-title {
    font-size:13px;
    font-weight:700;
    color:var(--text-secondary);
    text-transform:uppercase;
    letter-spacing:.8px;
}
.progress-stats {
    display:flex;
    align-items:center;
    gap:16px;
}
.progress-pct {
    font-family:'JetBrains Mono',monospace;
    font-size:20px;
    font-weight:700;
    color:var(--teal-dark);
}
.progress-sub {
    font-size:12px;
    color:var(--muted);
}
.progress-bonus {
    font-size:11px;
    font-weight:700;
    color:var(--priority);
    background:rgba(13,148,136,.08);
    padding:4px 10px;
    border-radius:4px;
    opacity:0;
    transition:opacity .4s;
}
.progress-bonus.show { opacity:1; }
.progress-bar-wrap {
    height:12px;
    background:var(--border-light);
    border-radius:6px;
    overflow:hidden;
    position:relative;
}
.progress-bar-fill {
    height:100%;
    border-radius:6px;
    background:var(--grad-progress);
    transition:width .6s cubic-bezier(.4,0,.2,1);
    position:relative;
}
.progress-bar-fill::after {
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(90deg, transparent 0%, rgba(255,255,255,.3) 50%, transparent 100%);
    border-radius:6px;
}
.progress-bar-fill.complete {
    animation:completePulse .7s ease;
}
@keyframes completePulse { 0%{filter:brightness(1)} 50%{filter:brightness(1.2)} 100%{filter:brightness(1)} }

/* summary */
.summary-box { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:28px; box-shadow:var(--shadow-sm); }
.summary-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
.summary-top h3 { font-size:18px; font-weight:700; letter-spacing:-.3px; color:var(--text); }
.copy-btn { background:var(--text); color:#fff; border:none; padding:9px 18px; border-radius:6px; font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; text-transform:uppercase; letter-spacing:.8px; transition:all .2s; box-shadow:var(--shadow-sm); }
.copy-btn:hover { background:var(--text-secondary); transform:translateY(-1px); }
.summary-out { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:22px; font-family:'JetBrains Mono',monospace; font-size:13px; line-height:1.9; color:var(--text); white-space:pre-wrap; min-height:110px; }
.summary-ph { color:var(--muted); font-style:italic; font-family:'Inter',sans-serif; }

/* category pills */
.cat-pills { display:flex; gap:6px; margin-bottom:14px; }
.cat-pill { flex:1; padding:8px 4px; border-radius:6px; text-align:center; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; cursor:pointer; border:1px solid var(--border); background:var(--card); color:var(--muted); transition:all .15s; font-family:inherit; }
.cat-pill:hover { border-color:var(--text-secondary); color:var(--text); }
.cat-pill.active-meeting { border-color:var(--meeting); color:var(--meeting); background:rgba(124,141,176,.08); }
.cat-pill.active-task    { border-color:var(--task);    color:var(--task);    background:rgba(90,154,138,.08); }
.cat-pill.active-admin   { border-color:var(--admin);   color:var(--admin);   background:rgba(160,128,96,.08); }
.cat-pill.active-pto     { border-color:var(--pto);     color:var(--pto);     background:rgba(138,138,138,.08); }

.hidden { display:none !important; }

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media (max-width: 1400px) {
    .layout { grid-template-columns: 300px 1fr; }
    .sidebar { padding: 24px 20px; }
}

@media (max-width: 1200px) {
    .layout { grid-template-columns: 280px 1fr; }
    .header { padding: 18px 24px; }
    .header h1 { font-size: 24px; }
    .main-area { padding: 24px 20px; }
    
    /* Compact hover overlay buttons - icons only */
    .hov-btn { padding: 6px 10px; font-size: 10px; letter-spacing: .4px; }
    .hov-btn .btn-text { display: none; }
    .item-hover-overlay { gap: 6px; }
}

@media (max-width: 1024px) {
    .layout { grid-template-columns: 260px 1fr; }
    
    /* Stack hover buttons vertically */
    .item-hover-overlay { 
        flex-direction: column; 
        gap: 5px; 
        padding: 8px;
    }
    .hov-btn { 
        padding: 5px 10px; 
        font-size: 10px; 
        width: 100%;
        justify-content: center;
    }
    
    /* Smaller day headers */
    .day-col-hdr { font-size: 11px; padding: 8px 10px; }
    .time-wrap { padding: 8px 10px; }
    .time-top { font-size: 11px; }
    .time-flex-note { font-size: 9px; }
    
    /* Compact items */
    .item { padding: 9px 11px; margin-bottom: 7px; }
    .item-name { font-size: 13px; }
    .item-meta { font-size: 10px; }
    .priority-badge { font-size: 9px; padding: 1px 5px; }
    .rec-badge { font-size: 8px; padding: 1px 4px; }
}

@media (max-width: 900px) {
    /* Switch to stacked layout */
    .layout { 
        grid-template-columns: 1fr; 
        grid-template-rows: auto 1fr;
    }
    .sidebar { 
        border-right: none; 
        border-bottom: 1px solid var(--border);
        max-height: 45vh;
        overflow-y: auto;
    }
    .main-area { padding: 20px 16px; }
    
    /* 2-row week grid on tablet */
    .week-grid { 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important; 
        gap: 12px;
    }
    .day-col { min-height: 280px; }
    
    /* Restore horizontal hover buttons with icons only */
    .item-hover-overlay { 
        flex-direction: row; 
        gap: 8px;
        padding: 0;
    }
    .hov-btn { 
        width: auto;
        padding: 8px 12px;
        font-size: 16px;
    }
    
    /* Header adjustments */
    .header { flex-wrap: wrap; gap: 12px; padding: 16px 20px; }
    .header h1 { font-size: 22px; }
    .header-sub { font-size: 11px; }
    .hdr-btns { gap: 8px; }
    .btn-hdr { padding: 8px 12px; font-size: 12px; }
    
    /* Progress section */
    .progress-header { flex-wrap: wrap; gap: 10px; }
    .progress-stats { gap: 10px; }
    .progress-pct { font-size: 18px; }
}

@media (max-width: 600px) {
    .header-left .compass { display: none; }
    .header h1 { font-size: 20px; }
    .btn-hdr span { display: none; }
    
    .week-grid { 
        grid-template-columns: 1fr !important;
        gap: 10px;
    }
    .day-col { min-height: 200px; padding: 14px; }
    .day-col-hdr { margin: -14px -14px 12px; padding: 10px 14px; }
    
    /* Full width hover overlay */
    .item-hover-overlay { justify-content: space-around; }
    .hov-btn { padding: 10px 16px; }
    
    .summary-box { padding: 20px; }
    .summary-out { padding: 16px; font-size: 12px; }
    
    /* Sidebar sections */
    .sidebar { padding: 20px 16px; max-height: 50vh; }
    .sec-title { font-size: 11px; }
    .cat-pills { flex-wrap: wrap; }
    .cat-pill { flex: 1 1 45%; }
    
    .progress-section { padding: 16px 18px; }
    .progress-title { font-size: 11px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WIZARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="wizardOverlay">
 <div class="panel">
  <div class="progress-bar"><div class="progress-fill" id="wProg" style="width:16%"></div></div>
  <div class="panel-body">

   <div class="step active" id="s1">
    <span class="step-emoji">üìã</span>
    <h2>Welcome to Weekly Navigator</h2>
    <p>Let's set up your week. A few quick questions ‚Äî and we'll calculate your real, realistic available hours.</p>
    <div class="nav-row"><span class="indicator">1 of 6</span><button class="btn-solid" onclick="goStep(2)">Get Started</button></div>
   </div>

   <div class="step" id="s2">
    <span class="step-emoji">üïò</span>
    <h2>When do you work?</h2>
    <p>Set your typical start and end times. We'll subtract breaks next.</p>
    <div class="irow"><div class="icon">üåÖ</div><div class="lbl">Day starts at<small>Usual start time</small></div><input type="time" id="wStart" value="09:00"></div>
    <div class="irow"><div class="icon">üåÜ</div><div class="lbl">Day ends at<small>Usual end time</small></div><input type="time" id="wEnd" value="17:00"></div>
    <div class="nav-row"><span class="indicator">2 of 6</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(1)">Back</button><button class="btn-solid" onclick="goStep(3)">Next</button></div></div>
   </div>

   <div class="step" id="s3">
    <span class="step-emoji">‚òï</span>
    <h2>How do you take breaks?</h2>
    <p>Be real here ‚Äî a planner only works if the math is honest.</p>
    <div class="irow"><div class="icon">üçΩÔ∏è</div><div class="lbl">Lunch break<small>How long, usually?</small></div><input type="number" id="wLunch" value="30" min="0" max="120" step="5"><span class="unit">min</span></div>
    <div class="irow"><div class="icon">üõãÔ∏è</div><div class="lbl">Short breaks per day<small>Coffee, walk, stretch‚Ä¶</small></div><input type="number" id="wBreakCt" value="2" min="0" max="10" step="1"><span class="unit">breaks</span></div>
    <div class="irow"><div class="icon">‚è±Ô∏è</div><div class="lbl">Each break is<small>Average length</small></div><input type="number" id="wBreakLen" value="15" min="5" max="60" step="5"><span class="unit">min</span></div>
    <div class="nav-row"><span class="indicator">3 of 6</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(2)">Back</button><button class="btn-solid" onclick="goStep(4)">Next</button></div></div>
   </div>

   <div class="step" id="s4">
    <span class="step-emoji">üìÖ</span>
    <h2>Which days do you work?</h2>
    <p>Tap to toggle the days you plan around.</p>
    <div class="days-grid" id="wDaysGrid"></div>
    <div class="calc-box"><div class="big" id="wCalcNum">32.5h</div><div class="desc"><strong>Raw hours this week</strong>After lunch &amp; breaks</div></div>
    <div class="nav-row"><span class="indicator">4 of 6</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(3)">Back</button><button class="btn-solid" onclick="goStep(5)">Next</button></div></div>
   </div>

   <div class="step" id="s5">
    <span class="step-emoji">üìä</span>
    <h2>Build in buffer time</h2>
    <p>Real days have interruptions ‚Äî Slack pings, quick fires, the unexpected. A flex buffer reserves a percentage of your day for life as it happens, so your plan stays realistic and achievable.</p>
    <div class="flex-row">
     <div class="flex-icon">üìä</div>
     <div class="flex-lbl">Flex buffer<small>Reserved for the unplanned</small></div>
     <input type="range" id="wFlexSlider" min="5" max="40" step="5" value="20" oninput="updFlexPreview()">
     <div class="flex-val" id="wFlexVal">20%</div>
    </div>
    <div class="calc-box" style="margin-top:18px;">
     <div class="big" id="wFlexCalc">26.0h</div>
     <div class="desc"><strong>Realistic deep-work hours</strong><span id="wFlexDesc">After 20% flex buffer</span></div>
    </div>
    <div class="nav-row"><span class="indicator">5 of 6</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(4)">Back</button><button class="btn-solid" onclick="goStep(6)">Next</button></div></div>
   </div>

   <div class="step" id="s6">
    <span class="step-emoji">üîÅ</span>
    <h2>Any recurring items?</h2>
    <p>Add meetings, tasks, admin, or PTO that repeat on a schedule. They'll appear as suggestions each week. Skip this and add them later if you prefer.</p>
    <div class="wiz-rec-form">
     <div class="wr-row"><input class="wr-name" type="text" id="wrName" placeholder="e.g. Team standup"><input class="wr-dur" type="number" id="wrDur" value="0.5" step="0.25" min="0.25"></div>
     <div class="wr-row"><select id="wrCat"><option value="meetings">Meeting</option><option value="tasks">Task</option><option value="admin">Admin</option><option value="pto">PTO</option></select><select id="wrDay"></select><select id="wrCadence"><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option><option value="daily">Daily</option></select><select id="wrMonthDay" class="hidden" style="width:80px;"></select></div>
     <button class="wr-add" onclick="wizAddRecurring()">+ Add</button>
    </div>
    <div class="wiz-rec-pills" id="wizRecPills"></div>
    <div class="nav-row"><span class="indicator">6 of 6</span><div class="nav-btns"><button class="btn-ghost" onclick="goStep(5)">Back</button><button class="btn-solid" onclick="wizardDone()">Launch</button></div></div>
   </div>

  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay hidden" id="settingsOverlay">
 <div class="panel" style="max-height:88vh;overflow-y:auto;">
  <div class="settings-header"><h2>‚öôÔ∏è Settings</h2><button class="close-btn" onclick="closeSettings()">‚úï</button></div>
  <div class="settings-body">
   <div class="settings-label">Work Hours</div>
   <div class="irow"><div class="icon">üåÖ</div><div class="lbl">Day starts at</div><input type="time" id="sStart"></div>
   <div class="irow"><div class="icon">üåÜ</div><div class="lbl">Day ends at</div><input type="time" id="sEnd"></div>
   <div class="settings-label">Breaks</div>
   <div class="irow"><div class="icon">üçΩÔ∏è</div><div class="lbl">Lunch break</div><input type="number" id="sLunch" min="0" max="120" step="5"><span class="unit">min</span></div>
   <div class="irow"><div class="icon">üõãÔ∏è</div><div class="lbl">Short breaks per day</div><input type="number" id="sBreakCt" min="0" max="10" step="1"><span class="unit">breaks</span></div>
   <div class="irow"><div class="icon">‚è±Ô∏è</div><div class="lbl">Each break is</div><input type="number" id="sBreakLen" min="5" max="60" step="5"><span class="unit">min</span></div>
   <div class="settings-label">Flex Buffer</div>
   <div class="flex-row">
    <div class="flex-icon">üìä</div>
    <div class="flex-lbl">Reserve for interruptions<small>Keeps your plan realistic</small></div>
    <input type="range" id="sFlexSlider" min="5" max="40" step="5" value="20" oninput="updSettingsFlexPreview()">
    <div class="flex-val" id="sFlexVal">20%</div>
   </div>
   <div class="settings-label">Work Days</div>
   <div class="days-grid" id="sDaysGrid"></div>
   <div class="calc-box"><div class="big" id="sCalcNum">26.0h</div><div class="desc"><strong>Realistic hours this week</strong><span id="sCalcSub">After breaks &amp; flex buffer</span></div></div>
   <button class="btn-solid" style="width:100%;margin-top:24px;" onclick="saveSettings()">Save Settings</button>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app" id="app">

 <div class="header">
  <div class="header-left">
   <div class="compass">üìã</div>
   <div><h1>Weekly <span>Navigator</span></h1><div class="header-sub">Focus ¬∑ Plan ¬∑ Execute</div></div>
  </div>
  <div class="hdr-btns">
   <button class="btn-hdr" onclick="openSettings()">‚öôÔ∏è Settings</button>
   <button class="btn-hdr danger" onclick="resetWeek()">Reset Week</button>
  </div>
 </div>

 <div class="layout">

  <div class="sidebar">

   <div class="sec-title">‚ûï Add Item</div>
   <div class="cat-pills" id="catPills">
    <button class="cat-pill active-meeting" data-cat="meetings" onclick="setCat('meetings')">Meeting</button>
    <button class="cat-pill" data-cat="tasks" onclick="setCat('tasks')">Task</button>
    <button class="cat-pill" data-cat="admin" onclick="setCat('admin')">Admin</button>
    <button class="cat-pill" data-cat="pto" onclick="setCat('pto')">PTO</button>
   </div>
   <div class="ig"><label>Name</label><input type="text" id="uName" placeholder="e.g. Team standup"></div>
   <div id="priorityWrap" class="priority-row" onclick="togglePriority()">
    <div class="priority-icon">‚ö°</div>
    <div class="priority-label">Priority item<small>Non-negotiable ¬∑ set with your manager</small></div>
    <div class="priority-toggle" id="priorityToggleBtn">OFF</div>
   </div>
   <div id="fullDayToggleWrap" class="hidden">
    <div class="fullday-row" id="fullDayRow" onclick="toggleFullDay()">
     <div class="toggle-track" id="fullDayTrack"><div class="knob"></div></div>
     <div class="fullday-label">Full day<small>Blocks the entire day</small></div>
    </div>
   </div>
   <div class="row2">
    <div class="ig"><label>Day</label><select id="uDay"></select></div>
    <div class="ig" id="uHoursWrap"><label>Hours</label><input type="number" id="uDur" value="0.5" step="0.25" min="0.25"></div>
   </div>
   <button class="add-btn" id="uAddBtn" onclick="addUnified()">Add Meeting</button>

   <div class="divider"></div>

   <div class="sec-title">üîÅ Recurring</div>
   <div id="recChips"></div>
   <div id="parityRow" class="hidden parity-row"><span>Bi-weekly phase off?</span><button class="parity-btn" onclick="flipParity()">Flip</button></div>
   <div class="wiz-rec-form" style="margin-top:8px;">
    <div class="wr-row"><input class="wr-name" type="text" id="sRecName" placeholder="New recurring‚Ä¶"><input class="wr-dur" type="number" id="sRecDur" value="0.5" step="0.25" min="0.25"></div>
    <div class="wr-row"><select id="sRecCat"><option value="meetings">Meeting</option><option value="tasks">Task</option><option value="admin">Admin</option><option value="pto">PTO</option></select><select id="sRecDay"></select><select id="sRecCadence" onchange="onSidebarCadenceChange()"><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option><option value="daily">Daily</option></select><select id="sRecMonthDay" class="hidden" style="width:80px;"></select></div>
    <button class="wr-add" onclick="sidebarAddRecurring()">+ Add</button>
   </div>

   <div class="divider"></div>

   <div class="sec-title">üìà This Week</div>
   <div class="stats-box" id="statsBox"></div>

   <div class="divider"></div>

   <div class="sec-title">üìä Time Breakdown</div>
   <div class="chart-box" style="margin-bottom:0;">
    <div class="chart-wrap"><canvas id="pieChart" width="170" height="170"></canvas></div>
    <div class="chart-legend" id="chartLeg"></div>
   </div>

  </div>

  <div class="main-area">
   <div id="suggestionsTray"></div>
   <div class="week-grid" id="weekGrid"></div>
   
   <!-- Horizontal Progress Bar -->
   <div class="progress-section">
    <div class="progress-header">
     <div class="progress-title">Weekly Progress</div>
     <div class="progress-stats">
      <div class="progress-bonus" id="progressBonus">‚ö° +bonus</div>
      <div class="progress-sub" id="progressSub">of planned hours</div>
      <div class="progress-pct" id="progressPct">0%</div>
     </div>
    </div>
    <div class="progress-bar-wrap">
     <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
    </div>
   </div>
   
   <div class="summary-box">
    <div class="summary-top"><h3>üìù Weekly Summary</h3><button class="copy-btn" onclick="copySummary()">Copy</button></div>
    <div class="summary-out" id="summaryOut"><span class="summary-ph">Check off completed items to build your weekly log‚Ä¶</span></div>
   </div>
  </div>

 </div>
</div>

<script>
const ALL_DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const MONTH_DAYS=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28];

let cfg={
    start:'09:00', end:'17:00', lunch:30, breakCt:2, breakLen:15,
    days:['Monday','Tuesday','Wednesday','Thursday','Friday'],
    recurring:[], parityFlip:false,
    flexPct:20
};
let data={};
let weekState={};
let drag=null;
let isFullDay=false;
let isPriority=false;
let lastProgressPct=-1;

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function dayHoursRaw(){
    const [sh,sm]=cfg.start.split(':').map(Number);
    const [eh,em]=cfg.end.split(':').map(Number);
    return Math.max(0,((eh*60+em)-(sh*60+sm))-cfg.lunch-cfg.breakCt*cfg.breakLen)/60;
}
function dayHours(){ return dayHoursRaw()*(1-cfg.flexPct/100); }
function weekHours(){ return dayHours()*cfg.days.length; }
function getMonday(d){ const date=new Date(d); date.setHours(0,0,0,0); const day=date.getDay(); date.setDate(date.getDate()-(day===0?-6:day-1)); return date; }
function thisWeekKey(){ return getMonday(new Date()).toISOString().slice(0,10); }

function isRecurringDueThisWeek(rec){
    const monday=new Date(thisWeekKey()+'T00:00:00');
    if(rec.cadence==='weekly'||rec.cadence==='daily') return true;
    if(rec.cadence==='biweekly'){
        const epoch=new Date('2024-01-01T00:00:00');
        const phase=Math.round((monday-epoch)/(7*24*60*60*1000))%2;
        const effectivePhase=cfg.parityFlip?(1-(rec.biweeklyPhase||0)):(rec.biweeklyPhase||0);
        return phase===effectivePhase;
    }
    if(rec.cadence==='monthly'){
        const md=rec.monthDay||1;
        for(let i=0;i<7;i++){ const d=new Date(monday); d.setDate(monday.getDate()+i); if(d.getDate()===md&&cfg.days.includes(ALL_DAYS[i])) return true; }
        return false;
    }
    return false;
}
function getDayForRecurring(rec){
    if(rec.cadence==='monthly'){
        const monday=new Date(thisWeekKey()+'T00:00:00');
        for(let i=0;i<7;i++){ const d=new Date(monday); d.setDate(monday.getDate()+i); if(d.getDate()===(rec.monthDay||1)) return ALL_DAYS[i]; }
    }
    return rec.day;
}
function getPendingSuggestions(){
    const ws=weekState[thisWeekKey()]||{dismissed:[],confirmed:[]};
    const out=[];
    cfg.recurring.forEach(r=>{
        if(!isRecurringDueThisWeek(r)) return;
        if(r.cadence==='daily'){ cfg.days.forEach(day=>{ const key=r.id+'_'+day; if(!ws.dismissed.includes(key)&&!ws.confirmed.includes(key)) out.push({rec:r,day,stateKey:key}); }); }
        else { if(!ws.dismissed.includes(r.id)&&!ws.confirmed.includes(r.id)) out.push({rec:r,day:getDayForRecurring(r),stateKey:r.id}); }
    });
    return out;
}
function confirmSuggestion(stateKey,recId,day){
    const wk=thisWeekKey();
    if(!weekState[wk]) weekState[wk]={dismissed:[],confirmed:[]};
    weekState[wk].confirmed.push(stateKey);
    const rec=cfg.recurring.find(r=>r.id===recId); if(!rec) return;
    if(!data[day]) data[day]={meetings:[],tasks:[],other:[]};
    const cat=rec.category||'meetings';
    const item={name:rec.name,duration:rec.duration,completed:false,recurringId:recId,priority:false};
    if(cat==='meetings') data[day].meetings.push(item);
    else if(cat==='tasks') data[day].tasks.push(item);
    else data[day].other.push({...item,subtype:cat,fullDay:false});
    save(); render();
}
function dismissSuggestion(stateKey){
    const wk=thisWeekKey();
    if(!weekState[wk]) weekState[wk]={dismissed:[],confirmed:[]};
    weekState[wk].dismissed.push(stateKey);
    save(); render();
}

function ensureData(){
    cfg.days.forEach(d=>{
        if(!data[d]) data[d]={meetings:[],tasks:[],other:[]};
        ['meetings','tasks','other'].forEach(k=>{ if(!data[d][k]) data[d][k]=[]; });
        if(data[d].admin){ data[d].admin.forEach(i=>data[d].other.push({name:i.name,duration:i.duration,completed:i.completed||false,subtype:'admin',fullDay:false,priority:false})); delete data[d].admin; }
        ['meetings','tasks','other'].forEach(k=>{ 
            data[d][k].forEach(i=>{ 
                if(i.important!==undefined && i.priority===undefined) { 
                    i.priority=i.important; 
                    delete i.important; 
                }
                if(i.priority===undefined) i.priority=false; 
            }); 
        });
    });
    if(!cfg.recurring) cfg.recurring=[];
    cfg.recurring.forEach(r=>{ if(!r.category) r.category='meetings'; });
    if(cfg.parityFlip===undefined) cfg.parityFlip=false;
    if(cfg.flexPct===undefined) cfg.flexPct=20;
}
function save(){
    localStorage.setItem('wp_cfg',JSON.stringify(cfg));
    localStorage.setItem('wp_data',JSON.stringify(data));
    localStorage.setItem('wp_weekState',JSON.stringify(weekState));
}

(function boot(){
    try {
        const c=localStorage.getItem('wp_cfg');
        if(c){
            cfg=JSON.parse(c); data=JSON.parse(localStorage.getItem('wp_data')||'{}'); weekState=JSON.parse(localStorage.getItem('wp_weekState')||'{}');
            ensureData();
            document.getElementById('wizardOverlay').classList.add('hidden');
            showApp();
        } else {
            renderDaysToggle('wDaysGrid'); updCalc('wCalcNum'); populateMonthDaySelect('wrMonthDay'); fillWizRecDaySelect(); updFlexPreview();
        }
    } catch(e){
        console.error('Boot error',e);
        localStorage.clear(); data={}; weekState={}; cfg={start:'09:00',end:'17:00',lunch:30,breakCt:2,breakLen:15,days:['Monday','Tuesday','Wednesday','Thursday','Friday'],recurring:[],parityFlip:false,flexPct:20};
        renderDaysToggle('wDaysGrid'); updCalc('wCalcNum'); populateMonthDaySelect('wrMonthDay'); fillWizRecDaySelect(); updFlexPreview();
    }
})();

function renderDaysToggle(id){
    const el=document.getElementById(id); el.innerHTML='';
    ALL_DAYS.forEach(d=>{
        const on=cfg.days.includes(d);
        const t=document.createElement('div'); t.className='day-tog'+(on?' on':'');
        t.innerHTML=`<div class="dlbl">${d.slice(0,3)}</div>`;
        t.onclick=()=>{
            if(cfg.days.includes(d)){ if(cfg.days.length>1) cfg.days=cfg.days.filter(x=>x!==d); }
            else { cfg.days.push(d); cfg.days.sort((a,b)=>ALL_DAYS.indexOf(a)-ALL_DAYS.indexOf(b)); }
            renderDaysToggle(id); updCalc(id==='wDaysGrid'?'wCalcNum':'sCalcNum');
            if(id==='wDaysGrid') updFlexPreview();
            if(id==='sDaysGrid') updSettingsFlexPreview();
        };
        el.appendChild(t);
    });
}
function updCalc(id){ document.getElementById(id).textContent=(dayHoursRaw()*cfg.days.length).toFixed(1)+'h'; }

function ordinal(n){ const s=['th','st','nd','rd'],v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); }
function populateMonthDaySelect(id){ const s=document.getElementById(id); if(!s) return; s.innerHTML=MONTH_DAYS.map(n=>`<option value="${n}">${ordinal(n)}</option>`).join(''); }
function fillWizRecDaySelect(){ const s=document.getElementById('wrDay'); if(!s) return; s.innerHTML=''; cfg.days.forEach(d=>s.innerHTML+=`<option value="${d}">${d}</option>`); }

function goStep(n){
    if(n>=3){ cfg.start=document.getElementById('wStart').value; cfg.end=document.getElementById('wEnd').value; }
    if(n>=4){ cfg.lunch=+document.getElementById('wLunch').value||30; cfg.breakCt=+document.getElementById('wBreakCt').value||0; cfg.breakLen=+document.getElementById('wBreakLen').value||15; updCalc('wCalcNum'); }
    if(n>=5){ updFlexPreview(); }
    if(n>=6){ cfg.flexPct=+document.getElementById('wFlexSlider').value; fillWizRecDaySelect(); renderWizRecPills(); }
    document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');
    document.getElementById('wProg').style.width=(n/6*100)+'%';
}
document.addEventListener('DOMContentLoaded',()=>{
    const wrCad=document.getElementById('wrCadence');
    if(wrCad) wrCad.addEventListener('change',()=>{
        document.getElementById('wrMonthDay').classList.toggle('hidden',wrCad.value!=='monthly');
        document.getElementById('wrDay').disabled=(wrCad.value==='daily');
    });
});

function updFlexPreview(){
    const pct=+document.getElementById('wFlexSlider').value;
    cfg.flexPct=pct;
    document.getElementById('wFlexVal').textContent=pct+'%';
    const hrs=dayHoursRaw()*cfg.days.length*(1-pct/100);
    document.getElementById('wFlexCalc').textContent=hrs.toFixed(1)+'h';
    document.getElementById('wFlexDesc').textContent='After '+pct+'% flex buffer';
}
function updSettingsFlexPreview(){
    const pct=+document.getElementById('sFlexSlider').value;
    document.getElementById('sFlexVal').textContent=pct+'%';
    const hrs=dayHoursRaw()*cfg.days.length*(1-pct/100);
    document.getElementById('sCalcNum').textContent=hrs.toFixed(1)+'h';
}

function calcBiweeklyPhase(){ return Math.round((getMonday(new Date())-new Date('2024-01-01T00:00:00'))/(7*24*60*60*1000))%2; }

function wizAddRecurring(){
    const name=document.getElementById('wrName').value.trim();
    const dur=parseFloat(document.getElementById('wrDur').value);
    const cat=document.getElementById('wrCat').value;
    const day=document.getElementById('wrDay').value;
    const cadence=document.getElementById('wrCadence').value;
    if(!name||!dur) return;
    cfg.recurring.push({ id:uid(),name,duration:dur,category:cat,day,cadence, monthDay:cadence==='monthly'?+document.getElementById('wrMonthDay').value:undefined, biweeklyPhase:cadence==='biweekly'?calcBiweeklyPhase():undefined });
    document.getElementById('wrName').value=''; document.getElementById('wrDur').value='0.5';
    renderWizRecPills();
}
function wizRemoveRecurring(id){ cfg.recurring=cfg.recurring.filter(r=>r.id!==id); renderWizRecPills(); }
function renderWizRecPills(){
    const el=document.getElementById('wizRecPills'); if(!el) return;
    const catLabels={meetings:'Meeting',tasks:'Task',admin:'Admin',pto:'PTO'};
    const catColors={meetings:'meeting',tasks:'task',admin:'admin',pto:'pto'};
    el.innerHTML=cfg.recurring.map(r=>{
        const cadL=r.cadence==='weekly'?'Weekly':r.cadence==='biweekly'?'Bi-weekly':r.cadence==='daily'?'Daily':`Monthly (${ordinal(r.monthDay)})`;
        const cat=r.category||'meetings';
        const catL=catLabels[cat];
        return `<div class="wiz-rec-pill"><div class="wp-left"><div class="wp-dot" style="background:var(--${catColors[cat]})"></div><span>${r.name} ¬∑ ${r.duration}h ¬∑ ${catL} ¬∑ ${r.cadence==='daily'?'All days':r.day} ¬∑ ${cadL}</span></div><button class="wp-rm" onclick="wizRemoveRecurring('${r.id}')">‚úï</button></div>`;
    }).join('');
}
function wizardDone(){ cfg.flexPct=+document.getElementById('wFlexSlider').value; ensureData(); save(); document.getElementById('wizardOverlay').classList.add('hidden'); showApp(); }

function openSettings(){
    document.getElementById('sStart').value=cfg.start; document.getElementById('sEnd').value=cfg.end;
    document.getElementById('sLunch').value=cfg.lunch; document.getElementById('sBreakCt').value=cfg.breakCt; document.getElementById('sBreakLen').value=cfg.breakLen;
    document.getElementById('sFlexSlider').value=cfg.flexPct; document.getElementById('sFlexVal').textContent=cfg.flexPct+'%';
    renderDaysToggle('sDaysGrid'); updSettingsFlexPreview();
    document.getElementById('settingsOverlay').classList.remove('hidden');
}
function closeSettings(){ document.getElementById('settingsOverlay').classList.add('hidden'); }
function saveSettings(){
    cfg.start=document.getElementById('sStart').value; cfg.end=document.getElementById('sEnd').value;
    cfg.lunch=+document.getElementById('sLunch').value||30; cfg.breakCt=+document.getElementById('sBreakCt').value||0; cfg.breakLen=+document.getElementById('sBreakLen').value||15;
    cfg.flexPct=+document.getElementById('sFlexSlider').value;
    ensureData(); save(); closeSettings(); fillSelects(); render();
}

function onSidebarCadenceChange(){
    const val=document.getElementById('sRecCadence').value;
    document.getElementById('sRecMonthDay').classList.toggle('hidden',val!=='monthly');
    document.getElementById('sRecDay').disabled=(val==='daily');
}
function sidebarAddRecurring(){
    const name=document.getElementById('sRecName').value.trim();
    const dur=parseFloat(document.getElementById('sRecDur').value);
    const cat=document.getElementById('sRecCat').value;
    const day=document.getElementById('sRecDay').value;
    const cadence=document.getElementById('sRecCadence').value;
    if(!name||!dur) return;
    cfg.recurring.push({ id:uid(),name,duration:dur,category:cat,day,cadence, monthDay:cadence==='monthly'?+document.getElementById('sRecMonthDay').value:undefined, biweeklyPhase:cadence==='biweekly'?calcBiweeklyPhase():undefined });
    document.getElementById('sRecName').value=''; document.getElementById('sRecDur').value='0.5';
    save(); render();
}
function deleteRecurring(id){
    cfg.recurring=cfg.recurring.filter(r=>r.id!==id);
    Object.keys(weekState).forEach(wk=>{
        if(weekState[wk].confirmed) weekState[wk].confirmed=weekState[wk].confirmed.filter(x=>x!==id&&!x.startsWith(id+'_'));
        if(weekState[wk].dismissed) weekState[wk].dismissed=weekState[wk].dismissed.filter(x=>x!==id&&!x.startsWith(id+'_'));
    });
    save(); render();
}
function flipParity(){
    cfg.parityFlip=!cfg.parityFlip;
    const wk=thisWeekKey();
    if(weekState[wk]){
        const isBi=k=>{ const r=cfg.recurring.find(x=>x.id===k.split('_')[0]); return r&&r.cadence==='biweekly'; };
        weekState[wk].dismissed=weekState[wk].dismissed.filter(k=>!isBi(k));
        weekState[wk].confirmed=weekState[wk].confirmed.filter(k=>!isBi(k));
        cfg.days.forEach(d=>{ if(data[d]&&data[d].meetings) data[d].meetings=data[d].meetings.filter(m=>{ if(!m.recurringId) return true; const r=cfg.recurring.find(x=>x.id===m.recurringId); return !(r&&r.cadence==='biweekly'); }); });
    }
    save(); render();
}

let activeCat='meetings';
function setCat(cat){
    activeCat=cat;
    document.querySelectorAll('.cat-pill').forEach(p=>p.className='cat-pill');
    const ac={meetings:'active-meeting',tasks:'active-task',admin:'active-admin',pto:'active-pto'};
    const pill=document.querySelector(`.cat-pill[data-cat="${cat}"]`); if(pill) pill.classList.add(ac[cat]);
    document.getElementById('priorityWrap').classList.toggle('hidden', cat==='pto');
    document.getElementById('fullDayToggleWrap').classList.toggle('hidden', cat!=='pto');
    if(cat!=='pto'){ isFullDay=false; syncFullDayUI(); }
    if(cat==='pto'){ isPriority=false; syncPriorityUI(); }
    document.getElementById('uAddBtn').textContent={meetings:'Add Meeting',tasks:'Add Task',admin:'Add Admin',pto:'Add PTO'}[cat];
    document.getElementById('uName').placeholder={meetings:'e.g. Team standup',tasks:'e.g. Write proposal',admin:'e.g. Email cleanup',pto:'e.g. Dentist appt'}[cat];
}
function togglePriority(){ isPriority=!isPriority; syncPriorityUI(); }
function syncPriorityUI(){
    document.getElementById('priorityWrap').classList.toggle('active',isPriority);
    document.getElementById('priorityToggleBtn').textContent=isPriority?'ON':'OFF';
}
function addUnified(){
    const name=document.getElementById('uName').value.trim();
    const day=document.getElementById('uDay').value;
    const dur=isFullDay?dayHours():parseFloat(document.getElementById('uDur').value);
    if(!name||!dur) return;
    const item={name,duration:dur,completed:false,priority:isPriority};
    if(activeCat==='meetings') data[day].meetings.push(item);
    else if(activeCat==='tasks') data[day].tasks.push(item);
    else data[day].other.push({...item,subtype:activeCat,fullDay:isFullDay});
    document.getElementById('uName').value=''; document.getElementById('uDur').value='0.5';
    isFullDay=false; syncFullDayUI(); isPriority=false; syncPriorityUI();
    save(); render();
}
function toggleFullDay(){ isFullDay=!isFullDay; syncFullDayUI(); }
function syncFullDayUI(){
    document.getElementById('fullDayTrack').classList.toggle('on',isFullDay);
    document.getElementById('fullDayRow').classList.toggle('active',isFullDay);
    document.getElementById('uHoursWrap').classList.toggle('hidden',isFullDay);
}

function toggleDone(day,cat,idx){
    data[day][cat][idx].completed=!data[day][cat][idx].completed;
    save(); render();
}
function toggleItemPriority(day,cat,idx){
    data[day][cat][idx].priority=!data[day][cat][idx].priority;
    save(); render();
}
function deleteItem(day,cat,idx){
    data[day][cat].splice(idx,1);
    save(); render();
}
function startInlineEdit(day,cat,idx){
    const item=data[day][cat][idx];
    const card=document.querySelector(`[data-day="${day}"][data-cat="${cat}"][data-idx="${idx}"]`);
    if(!card) return;
    card.classList.add('editing');
    const inner=card.querySelector('.item-inner');
    const oldName=item.name, oldDur=item.duration;
    inner.innerHTML=`<div class="item-edit-row"><input class="ef-name" type="text" value="${oldName}"><input class="ef-dur" type="number" step="0.25" min="0.25" value="${oldDur}"><div class="ef-btns"><button class="ef-save" title="Save">‚úì</button><button class="ef-cancel" title="Cancel">‚úï</button></div></div>`;
    const nameInp=inner.querySelector('.ef-name'), durInp=inner.querySelector('.ef-dur');
    nameInp.focus(); nameInp.select();
    const commitEdit=()=>{
        const newName=nameInp.value.trim(), newDur=parseFloat(durInp.value);
        if(newName&&newDur>0){ item.name=newName; item.duration=newDur; save(); }
        render();
    };
    inner.querySelector('.ef-save').onclick=e=>{ e.stopPropagation(); commitEdit(); };
    inner.querySelector('.ef-cancel').onclick=e=>{ e.stopPropagation(); render(); };
    nameInp.addEventListener('keydown',e=>{ if(e.key==='Enter') commitEdit(); if(e.key==='Escape') render(); });
    durInp.addEventListener('keydown',e=>{ if(e.key==='Enter') commitEdit(); if(e.key==='Escape') render(); });
}

function onDragStart(e,day,cat,idx){
    drag={day,cat,idx};
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain','');
}
function onDragEnd(e){ drag=null; e.target.classList.remove('dragging'); document.querySelectorAll('.day-col').forEach(c=>c.classList.remove('drag-over')); }
function onDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
function onDragEnter(e){ e.currentTarget.classList.add('drag-over'); }
function onDragLeave(e){ e.currentTarget.classList.remove('drag-over'); }
function onDrop(e,toDay){
    e.preventDefault(); e.currentTarget.classList.remove('drag-over');
    if(!drag) return;
    const {day:fromDay,cat,idx}=drag;
    const item=data[fromDay][cat].splice(idx,1)[0];
    data[toDay][cat].push(item);
    save(); render();
}

function showApp(){
    document.getElementById('app').classList.add('on');
    fillSelects(); render();
}
function fillSelects(){
    ['uDay','sRecDay'].forEach(id=>{
        const s=document.getElementById(id); if(!s) return;
        s.innerHTML=''; cfg.days.forEach(d=>s.innerHTML+=`<option value="${d}">${d}</option>`);
    });
    populateMonthDaySelect('sRecMonthDay');
}
function render(){
    renderSuggestions(); renderWeek(); renderRecChips(); renderStats(); renderChart(); renderProgressBar(); renderSummary();
}

function renderSuggestions(){
    const pending=getPendingSuggestions();
    const tray=document.getElementById('suggestionsTray');
    if(!pending.length){ tray.innerHTML=''; return; }
    const catLabels={meetings:'Meeting',tasks:'Task',admin:'Admin',pto:'PTO'};
    const cadLabels={weekly:'Weekly',biweekly:'Bi-weekly',monthly:'Monthly',daily:'Daily'};
    tray.innerHTML=`<div class="suggestions-tray"><div class="suggestions-title">üìÖ Recurring Suggestions <span class="s-count">${pending.length}</span></div>${pending.map(s=>{
        const cat=s.rec.category||'meetings';
        const catL=catLabels[cat];
        const cadL=cadLabels[s.rec.cadence]||s.rec.cadence;
        return `<div class="suggestion-item"><div class="si-inner"><div class="si-name">${s.rec.name}</div><div class="si-meta">${catL} ¬∑ ${s.day} ¬∑ ${s.rec.duration}h ¬∑ ${cadL}</div></div><div class="si-btns"><button class="si-btn add" onclick="confirmSuggestion('${s.stateKey}','${s.rec.id}','${s.day}')">Add</button><button class="si-btn skip" onclick="dismissSuggestion('${s.stateKey}')">Skip</button></div></div>`;
    }).join('')}</div>`;
}
function renderRecChips(){
    const el=document.getElementById('recChips');
    const hasBi=cfg.recurring.some(r=>r.cadence==='biweekly');
    document.getElementById('parityRow').classList.toggle('hidden',!hasBi);
    const catLabels={meetings:'Meeting',tasks:'Task',admin:'Admin',pto:'PTO'};
    const catColors={meetings:'meeting',tasks:'task',admin:'admin',pto:'pto'};
    el.innerHTML=cfg.recurring.map(r=>{
        const cadL=r.cadence==='weekly'?'Weekly':r.cadence==='biweekly'?'Bi-weekly':r.cadence==='daily'?'Daily':`Monthly (${ordinal(r.monthDay)})`;
        const cat=r.category||'meetings';
        const catL=catLabels[cat];
        return `<div class="rec-chip" style="border-left-color:var(--${catColors[cat]})"><div class="rc-inner"><div class="rc-name">${r.name}</div><div class="rc-meta">${catL} ¬∑ ${r.cadence==='daily'?'All work days':r.day} ¬∑ ${r.duration}h ¬∑ ${cadL}</div></div><button class="rc-del" onclick="deleteRecurring('${r.id}')">‚úï</button></div>`;
    }).join('');
}

function renderWeek(){
    const g=document.getElementById('weekGrid');
    g.style.gridTemplateColumns=`repeat(${cfg.days.length},1fr)`;
    g.innerHTML=cfg.days.map(day=>{
        const dh=dayHours();
        let used=0;
        (data[day]?.meetings||[]).forEach(i=>used+=i.duration);
        (data[day]?.tasks||[]).forEach(i=>used+=i.duration);
        (data[day]?.other||[]).forEach(i=>used+=i.duration);
        const free=dh-used;
        const pct=Math.min(100,Math.round((used/dh)*100));
        const cls=free<0?'over':free<1?'warn':'ok';

        const fullPto=(data[day]?.other||[]).find(i=>i.subtype==='pto'&&i.fullDay);
        let ptoHtml='';
        if(fullPto){
            const oIdx=(data[day].other||[]).indexOf(fullPto);
            ptoHtml=`<div class="pto-banner"><div class="pto-label">üèñÔ∏è ${fullPto.name}</div><div class="pto-sub">Full day PTO</div><button class="pto-rm" onclick="deleteItem('${day}','other',${oIdx})">Remove</button></div>`;
        }

        const sortByPriority=(arr)=>[...arr].sort((a,b)=>(b.priority?1:0)-(a.priority?1:0));
        const meetings=sortByPriority(data[day]?.meetings||[]);
        const tasks=sortByPriority(data[day]?.tasks||[]);
        const other=(data[day]?.other||[]).filter(i=>!(i.subtype==='pto'&&i.fullDay));

        const items=[
            ...meetings.map((i,idx)=>({...i,cat:'meetings',idx:(data[day].meetings||[]).indexOf(i),type:'meeting'})),
            ...tasks.map((i,idx)=>({...i,cat:'tasks',idx:(data[day].tasks||[]).indexOf(i),type:'task'})),
            ...other.map((i,idx)=>({...i,cat:'other',idx:(data[day].other||[]).indexOf(i),type:i.subtype}))
        ];

        return `<div class="day-col" ondragover="onDragOver(event)" ondragenter="onDragEnter(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event,'${day}')">
            <div class="day-col-hdr">${day}</div>
            <div class="time-wrap">
                <div class="time-top"><span class="time-used">${used.toFixed(1)}h used</span><span class="time-free ${cls}">${free>=0?free.toFixed(1)+'h left':'Over by '+(-free).toFixed(1)+'h'}</span></div>
                <div class="tbar"><div class="tbar-fill ${cls}" style="width:${pct}%"></div></div>
                <div class="time-flex-note">üìä ${cfg.flexPct}% buffer reserved</div>
            </div>
            ${ptoHtml}
            ${items.map(i=>{
                const done=i.completed?'done':'';
                const typeClass={meeting:'',task:'task',admin:'admin',pto:'pto'}[i.type]||'';
                const priorityClass=i.priority?'priority':'';
                const priorityBadge=i.priority?`<span class="priority-badge">‚ö° Priority</span>`:'';
                const recBadge=i.recurringId?'<span class="rec-badge">Recurring</span>':'';
                const priorityBtnClass=i.priority?'priority-on':'';
                const canHavePriority=(i.cat==='meetings'||i.cat==='tasks'||(i.cat==='other'&&i.type==='admin'));
                const priorityBtn=canHavePriority?`<button class="hov-btn ${priorityBtnClass}" onclick="event.stopPropagation();toggleItemPriority('${day}','${i.cat}',${i.idx})">‚ö°</button>`:'';
                return `<div class="item ${typeClass} ${done} ${priorityClass}" draggable="true" ondragstart="onDragStart(event,'${day}','${i.cat}',${i.idx})" ondragend="onDragEnd(event)" data-day="${day}" data-cat="${i.cat}" data-idx="${i.idx}">
                    <div class="item-top">
                        <input type="checkbox" class="item-cb" ${i.completed?'checked':''} onclick="event.stopPropagation();toggleDone('${day}','${i.cat}',${i.idx})">
                        <div class="item-inner">
                            <div class="item-name">${i.name}${priorityBadge}${recBadge}</div>
                            <div class="item-meta">${i.duration}h${i.fullDay?' ¬∑ Full Day':''}</div>
                        </div>
                    </div>
                    <div class="item-hover-overlay">
                        <button class="hov-btn" onclick="event.stopPropagation();startInlineEdit('${day}','${i.cat}',${i.idx})">‚úèÔ∏è<span class="btn-text"> Edit</span></button>
                        ${priorityBtn}
                        <button class="hov-btn del" onclick="event.stopPropagation();deleteItem('${day}','${i.cat}',${i.idx})">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('')}
        </div>`;
    }).join('');
}

function renderChart(){
    const canvas=document.getElementById('pieChart');
    const ctx=canvas.getContext('2d');
    const cx=85,cy=85,r=75;
    ctx.clearRect(0,0,170,170);
    let M=0,T=0,A=0,P=0;
    cfg.days.forEach(d=>{
        (data[d]?.meetings||[]).forEach(i=>M+=i.duration);
        (data[d]?.tasks||[]).forEach(i=>T+=i.duration);
        (data[d]?.other||[]).forEach(i=>{ if(i.subtype==='pto') P+=i.duration; else A+=i.duration; });
    });
    const tot=M+T+A+P;
    if(tot===0){ ctx.fillStyle='#e2e5eb'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(cx,cy,r-20,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#718096'; ctx.font='500 13px "Inter",sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('No data',cx,cy); document.getElementById('chartLeg').innerHTML=''; return; }
    const slices=[
        {val:M,base:'#7c8db0',light:'#a3b1cf',label:'Meetings'},
        {val:T,base:'#5a9a8a',light:'#7ab8a8',label:'Tasks'},
        {val:A,base:'#a08060',light:'#c4a882',label:'Admin'},
        {val:P,base:'#8a8a8a',light:'#aaa',label:'PTO'}
    ].filter(s=>s.val>0);
    let ang=-Math.PI/2;
    slices.forEach(s=>{
        const sw=(s.val/tot)*Math.PI*2;
        const grad=ctx.createLinearGradient(cx-r,cy-r,cx+r,cy+r);
        grad.addColorStop(0,s.base); grad.addColorStop(1,s.light);
        ctx.fillStyle=grad; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,ang,ang+sw); ctx.closePath(); ctx.fill();
        ang+=sw;
    });
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(cx,cy,r-20,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#2d3748'; ctx.font='700 15px "JetBrains Mono",monospace'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(tot.toFixed(1)+'h',cx,cy);
    document.getElementById('chartLeg').innerHTML=slices.map(s=>`<div class="leg-row"><div class="leg-left"><div class="leg-dot" style="background:linear-gradient(135deg,${s.base},${s.light})"></div><span class="leg-name">${s.label}</span></div><span class="leg-val">${s.val.toFixed(1)}h</span></div>`).join('');
}

function renderStats(){
    let M=0,T=0,A=0,P=0,over=0,priorityCount=0,priorityDone=0;
    const dh=dayHours();
    cfg.days.forEach(d=>{
        let u=0;
        (data[d]?.meetings||[]).forEach(i=>{ M+=i.duration; u+=i.duration; if(i.priority){ priorityCount++; if(i.completed) priorityDone++; } });
        (data[d]?.tasks||[]).forEach(i=>{ T+=i.duration; u+=i.duration; if(i.priority){ priorityCount++; if(i.completed) priorityDone++; } });
        (data[d]?.other||[]).forEach(i=>{ if(i.subtype==='pto') P+=i.duration; else { A+=i.duration; if(i.priority){ priorityCount++; if(i.completed) priorityDone++; } } u+=i.duration; });
        if(u>dh) over++;
    });
    const tot=M+T+A+P;
    let priorityHtml='';
    if(priorityCount>0){
        const allDone=priorityDone===priorityCount;
        priorityHtml=`<div class="st-div"></div><div class="st-row"><span class="st-label">‚ö° Priority items</span><span class="st-val" style="color:${allDone?'var(--task)':'var(--priority)'};">${priorityDone}/${priorityCount} ${allDone?'‚úì All clear':'remaining'}</span></div>`;
    }
    document.getElementById('statsBox').innerHTML=`
        <div class="st-row"><span class="st-label">Meetings</span><span class="st-val">${M.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">Tasks</span><span class="st-val">${T.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">Admin</span><span class="st-val">${A.toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label">PTO</span><span class="st-val">${P.toFixed(1)}h</span></div>
        <div class="st-div"></div>
        <div class="st-row"><span class="st-label">Week Total</span><span class="st-val">${tot.toFixed(1)}h / ${weekHours().toFixed(1)}h</span></div>
        <div class="st-row"><span class="st-label" style="color:var(--teal-mid);">üìä Flex buffer</span><span class="st-val" style="color:var(--teal-mid);">${cfg.flexPct}%</span></div>
        ${priorityHtml}
        ${over>0?`<div class="alert alert-warn">‚ö†Ô∏è ${over} day(s) overbooked</div>`:tot>0?`<div class="alert alert-ok">‚úì Week balanced</div>`:''}`;
}

function renderProgressBar(){
    let totalPlanned=0, totalDone=0, priorityCount=0, priorityDone=0;
    cfg.days.forEach(d=>{
        [...(data[d]?.meetings||[]),...(data[d]?.tasks||[]),...(data[d]?.other||[])].forEach(i=>{
            totalPlanned+=i.duration;
            if(i.completed) totalDone+=i.duration;
            if(i.priority){ priorityCount++; if(i.completed) priorityDone++; }
        });
    });

    const basePct = totalPlanned>0 ? Math.min((totalDone/totalPlanned)*80, 80) : 0;
    const bonusPts = priorityDone * 5;
    const rawPct = basePct + bonusPts;
    const pct = Math.min(Math.round(rawPct), 100);

    const fill=document.getElementById('progressFill');
    fill.style.width=pct+'%';
    fill.classList.toggle('complete', pct>=100);
    document.getElementById('progressPct').textContent=pct+'%';

    const sub=document.getElementById('progressSub');
    if(pct>=100) sub.textContent='‚úì Week complete!';
    else if(priorityCount>0 && priorityDone<priorityCount) sub.textContent=`${priorityCount-priorityDone} priority${priorityCount-priorityDone>1?'s':''} remaining`;
    else sub.textContent='of planned hours';

    const bonus=document.getElementById('progressBonus');
    if(priorityDone>0 && pct>lastProgressPct && bonusPts>0){
        bonus.textContent=`‚ö° +${Math.min(bonusPts,20)} bonus`;
        bonus.classList.add('show');
        setTimeout(()=>bonus.classList.remove('show'), 2200);
    }
    lastProgressPct=pct;
}

function renderSummary(){
    let lines=[],any=false,cM=0,cT=0,cA=0,cP=0;
    cfg.days.forEach(day=>{
        const dl=[];
        (data[day]?.meetings||[]).filter(i=>i.completed).forEach(i=>{
            const flag=i.priority?' ‚ö°':'';
            dl.push(`  ‚Ä¢ ${i.name}${i.recurringId?' [recurring]':''}${flag} (${i.duration}h)`);
            cM+=i.duration; any=true;
        });
        (data[day]?.tasks||[]).filter(i=>i.completed).forEach(i=>{
            const flag=i.priority?' ‚ö°':'';
            dl.push(`  ‚Ä¢ ${i.name}${flag} (${i.duration}h)`);
            cT+=i.duration; any=true;
        });
        (data[day]?.other||[]).filter(i=>i.completed).forEach(i=>{ const flag=(i.subtype==='admin'&&i.priority)?' ‚ö°':''; dl.push(`  ‚Ä¢ ${i.name}${flag} (${i.duration}h ¬∑ ${i.subtype==='pto'?'PTO':'Admin'}${i.fullDay?' ‚Äì Full Day':''})`); if(i.subtype==='pto') cP+=i.duration; else cA+=i.duration; any=true; });
        if(dl.length){ lines.push(day.toUpperCase()); lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'); lines.push(...dl); lines.push(''); }
    });
    if(!any){ document.getElementById('summaryOut').innerHTML='<span class="summary-ph">Check off completed items to build your weekly log‚Ä¶</span>'; return; }
    const cTot=cM+cT+cA+cP;
    lines.push('HOURS BREAKDOWN');
    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    lines.push(`  Meetings:     ${cM.toFixed(1)}h`);
    lines.push(`  Tasks:        ${cT.toFixed(1)}h`);
    lines.push(`  Admin:        ${cA.toFixed(1)}h`);
    lines.push(`  PTO:          ${cP.toFixed(1)}h`);
    lines.push(`  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
    lines.push(`  Total:        ${cTot.toFixed(1)}h`);
    document.getElementById('summaryOut').textContent=lines.join('\n');
}
function copySummary(){
    const el=document.getElementById('summaryOut');
    if(el.querySelector('.summary-ph')) return;
    navigator.clipboard.writeText(el.textContent).then(()=>{ const b=document.querySelector('.copy-btn'); b.textContent='Copied!'; setTimeout(()=>b.textContent='Copy',2000); });
}

function resetWeek(){
    if(!confirm('Clear this week? Recurring suggestions will reappear.')) return;
    data={}; ensureData(); delete weekState[thisWeekKey()];
    save(); render();
}
</script>
</body>
</html>
